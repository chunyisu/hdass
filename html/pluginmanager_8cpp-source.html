<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>HDASS: pluginmanager.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>pluginmanager.cpp</h1><a href="pluginmanager_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">begin                : 2004/03/12</span>
00003 <span class="comment">copyright            : (C) Mark Kretschmann</span>
00004 <span class="comment">email                : markey@web.de</span>
00005 <span class="comment">***************************************************************************/</span>
00006 
00007 <span class="comment">/***************************************************************************</span>
00008 <span class="comment"> *                                                                         *</span>
00009 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
00010 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
00011 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
00012 <span class="comment"> *   (at your option) any later version.                                   *</span>
00013 <span class="comment"> *                                                                         *</span>
00014 <span class="comment"> ***************************************************************************/</span>
00015 
00016 <span class="preprocessor">#include "<a class="code" href="plugin_8h.html">plugin.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="pluginmanager_8h.html">pluginmanager.h</a>"</span>
00018 
00019 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00020 <span class="preprocessor">#include &lt;vector&gt;</span>
00021 
00022 <span class="preprocessor">#include &lt;qfile.h&gt;</span>
00023 <span class="preprocessor">#include &lt;qstring.h&gt;</span>
00024 
00025 <span class="preprocessor">#include &lt;kdebug.h&gt;</span>
00026 <span class="preprocessor">#include &lt;klibloader.h&gt;</span>
00027 
00028 vector&lt;PluginManager::StoreItem&gt;
<a name="l00029"></a><a class="code" href="classPluginManager.html#PluginManagerv0">00029</a> <a class="code" href="classPluginManager.html#PluginManagerv0">PluginManager::m_store</a>;
00030 
00031 
00033 <span class="comment">// PUBLIC INTERFACE</span>
00035 <span class="comment"></span>
00036 KTrader::OfferList     
<a name="l00037"></a><a class="code" href="classPluginManager.html#PluginManagere0">00037</a> <a class="code" href="classPluginManager.html#PluginManagere0">PluginManager::query</a>( <span class="keyword">const</span> QString&amp; constraint )
00038 {    
00039     <span class="comment">// Add versioning constraint</span>
00040     QString str = QString( <span class="stringliteral">"[X-KDE-amaroK-framework-version] &gt;= %1 and "</span> )
00041                      .arg( <a class="code" href="classPluginManager.html#PluginManagers0">FrameworkVersion</a> );
00042     
00043     kdDebug() &lt;&lt; k_funcinfo &lt;&lt; endl
00044               &lt;&lt; <span class="stringliteral">"Plugin trader constraint: "</span> &lt;&lt; str + constraint &lt;&lt; endl;
00045     
00046     <span class="keywordflow">return</span> KTrader::self()-&gt;query( <span class="stringliteral">"amaroK/Plugin"</span>, str + constraint );
00047 }    
00048     
00049     
00050 <a class="code" href="classPlugin.html">Plugin</a>*
<a name="l00051"></a><a class="code" href="classPluginManager.html#PluginManagere1">00051</a> <a class="code" href="classPluginManager.html#PluginManagere1">PluginManager::createFromQuery</a>( <span class="keyword">const</span> QString&amp; constraint )
00052 {
00053     KTrader::OfferList offers = <a class="code" href="classPluginManager.html#PluginManagere0">query</a>( constraint );
00054 
00055     <span class="keywordflow">if</span> ( offers.isEmpty() ) {
00056         kdWarning() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">"No matching plugin found.\n"</span>;                                          
00057         <span class="keywordflow">return</span> 0;
00058     }
00059                 
00060     <span class="keywordflow">return</span> <a class="code" href="classPluginManager.html#PluginManagere2">createFromService</a>( *offers.begin() );    
00061 }
00062 
00063     
00064 <a class="code" href="classPlugin.html">Plugin</a>*
<a name="l00065"></a><a class="code" href="classPluginManager.html#PluginManagere2">00065</a> <a class="code" href="classPluginManager.html#PluginManagere2">PluginManager::createFromService</a>( <span class="keyword">const</span> KService::Ptr service )
00066 {
00067     kdDebug() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">"Trying to load: "</span> &lt;&lt; service-&gt;library() &lt;&lt; endl;
00068     
00069     <span class="comment">//get the library loader instance</span>
00070     KLibLoader *loader = KLibLoader::self();
00071     <span class="comment">//try to load the specified library</span>
00072     KLibrary *lib = loader-&gt;globalLibrary( QFile::encodeName( service-&gt;library() ) );
00073 
00074     <span class="keywordflow">if</span> ( !lib ) {
00075         kdWarning() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">"lib == NULL\n"</span>;
00076         <span class="keywordflow">return</span> 0;
00077     }
00078     <span class="comment">//look up address of init function and cast it to pointer-to-function</span>
00079     <a class="code" href="classPlugin.html">Plugin</a>* (*create_plugin)() = ( <a class="code" href="classPlugin.html">Plugin</a>* (*)() ) lib-&gt;symbol( <span class="stringliteral">"create_plugin"</span> );
00080     
00081     <span class="keywordflow">if</span> ( !create_plugin ) {
00082         kdWarning() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">"create_plugin == NULL\n"</span>;
00083         <span class="keywordflow">return</span> 0;
00084     }
00085     <span class="comment">//create plugin on the heap</span>
00086     <a class="code" href="classPlugin.html">Plugin</a>* plugin = create_plugin();
00087     
00088     <span class="comment">//put plugin into store</span>
00089     <a class="code" href="structPluginManager_1_1StoreItem.html">StoreItem</a> item;
00090     item.<a class="code" href="structPluginManager_1_1StoreItem.html#PluginManager_1_1StoreItemo0">plugin</a> = plugin;
00091     item.<a class="code" href="structPluginManager_1_1StoreItem.html#PluginManager_1_1StoreItemo1">library</a> = lib;
00092     item.<a class="code" href="structPluginManager_1_1StoreItem.html#PluginManager_1_1StoreItemo2">service</a> = service;
00093     <a class="code" href="classPluginManager.html#PluginManagerv0">m_store</a>.push_back( item );
00094     
00095     <a class="code" href="classPluginManager.html#PluginManagere5">dump</a>( service );
00096     <span class="keywordflow">return</span> plugin;
00097 }
00098 
00099 
00100 <span class="keywordtype">void</span>
<a name="l00101"></a><a class="code" href="classPluginManager.html#PluginManagere3">00101</a> <a class="code" href="classPluginManager.html#PluginManagere3">PluginManager::unload</a>( <a class="code" href="classPlugin.html">Plugin</a>* plugin )
00102 {
00103     kdDebug() &lt;&lt; k_funcinfo &lt;&lt; endl;
00104     
00105     vector&lt;StoreItem&gt;::iterator iter = <a class="code" href="classPluginManager.html#PluginManagerh0">lookupPlugin</a>( plugin ); 
00106             
00107     <span class="keywordflow">if</span> ( iter != <a class="code" href="classPluginManager.html#PluginManagerv0">m_store</a>.end() ) {
00108         <span class="keyword">delete</span> (*iter).plugin;
00109         kdDebug() &lt;&lt; <span class="stringliteral">"Unloading library: "</span>&lt;&lt; (*iter).service-&gt;library() &lt;&lt; endl;
00110         (*iter).library-&gt;unload();
00111         
00112         <a class="code" href="classPluginManager.html#PluginManagerv0">m_store</a>.erase( iter );
00113     }
00114     <span class="keywordflow">else</span>
00115         kdWarning() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">"Could not unload plugin (not found in store).\n"</span>;
00116 }
00117 
00118 
00119 KService::Ptr
<a name="l00120"></a><a class="code" href="classPluginManager.html#PluginManagere4">00120</a> <a class="code" href="classPluginManager.html#PluginManagere4">PluginManager::getService</a>( <span class="keyword">const</span> <a class="code" href="classPlugin.html">Plugin</a>* plugin )
00121 {
00122     kdDebug() &lt;&lt; k_funcinfo &lt;&lt; endl;
00123     
00124     <span class="keywordflow">if</span> ( !plugin ) {
00125         kdWarning() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">"pointer == NULL\n"</span>;   
00126         <span class="keywordflow">return</span> 0;
00127     }
00128        
00129     <span class="comment">//search plugin in store</span>
00130     vector&lt;StoreItem&gt;::const_iterator iter = <a class="code" href="classPluginManager.html#PluginManagerh0">lookupPlugin</a>( plugin ); 
00131     
00132     <span class="keywordflow">if</span> ( iter == <a class="code" href="classPluginManager.html#PluginManagerv0">m_store</a>.end() ) 
00133         kdWarning() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">"Plugin not found in store.\n"</span>;
00134     
00135     <span class="keywordflow">return</span> (*iter).service;
00136 }
00137 
00138 
00139 <span class="keywordtype">void</span>    
<a name="l00140"></a><a class="code" href="classPluginManager.html#PluginManagere5">00140</a> <a class="code" href="classPluginManager.html#PluginManagere5">PluginManager::dump</a>( <span class="keyword">const</span> KService::Ptr service )
00141 {
00142     assert( service.data() );
00143     
00144     kdDebug() &lt;&lt; endl;
00145     
00146     kdDebug() &lt;&lt; <span class="stringliteral">"PluginManager Service DUMP:\n"</span>;
00147     kdDebug() &lt;&lt; <span class="stringliteral">"---------------------------\n"</span>;
00148     kdDebug() &lt;&lt; <span class="stringliteral">"name                          : "</span>
00149                 &lt;&lt; service-&gt;name()                                                  &lt;&lt; endl;
00150     kdDebug() &lt;&lt; <span class="stringliteral">"library                       : "</span>
00151                 &lt;&lt; service-&gt;library()                                               &lt;&lt; endl;
00152     kdDebug() &lt;&lt; <span class="stringliteral">"desktopEntryPath              : "</span>
00153                 &lt;&lt; service-&gt;desktopEntryPath()                                      &lt;&lt; endl;
00154     kdDebug() &lt;&lt; <span class="stringliteral">"X-KDE-plugintype              : "</span>
00155                 &lt;&lt; service-&gt;property( <span class="stringliteral">"X-KDE-amaroK-plugintype"</span> ).toString()        &lt;&lt; endl;
00156     kdDebug() &lt;&lt; <span class="stringliteral">"X-KDE-amaroK-authors          : "</span>
00157                 &lt;&lt; service-&gt;property( <span class="stringliteral">"X-KDE-amaroK-authors"</span> ).toStringList()       &lt;&lt; endl;
00158     kdDebug() &lt;&lt; <span class="stringliteral">"X-KDE-amaroK-version          : "</span>
00159                 &lt;&lt; service-&gt;property( <span class="stringliteral">"X-KDE-amaroK-version"</span> ).toString()           &lt;&lt; endl;
00160     kdDebug() &lt;&lt; <span class="stringliteral">"X-KDE-amaroK-framework-version: "</span>
00161                 &lt;&lt; service-&gt;property( <span class="stringliteral">"X-KDE-amaroK-framework-version"</span> ).toString() &lt;&lt; endl;
00162     
00163     kdDebug() &lt;&lt; endl;
00164 }
00165 
00166     
00168 <span class="comment">// PRIVATE INTERFACE</span>
00170 <span class="comment"></span>
00171 vector&lt;PluginManager::StoreItem&gt;::iterator
<a name="l00172"></a><a class="code" href="classPluginManager.html#PluginManagerh0">00172</a> <a class="code" href="classPluginManager.html#PluginManagerh0">PluginManager::lookupPlugin</a>( <span class="keyword">const</span> <a class="code" href="classPlugin.html">Plugin</a>* plugin )
00173 {
00174     vector&lt;StoreItem&gt;::iterator iter; 
00175     
00176     <span class="comment">//search plugin pointer in store</span>
00177     <span class="keywordflow">for</span> ( iter = <a class="code" href="classPluginManager.html#PluginManagerv0">m_store</a>.begin(); iter != <a class="code" href="classPluginManager.html#PluginManagerv0">m_store</a>.end(); iter++ ) {
00178         <span class="keywordflow">if</span> ( (*iter).plugin == plugin )
00179             <span class="keywordflow">break</span>;
00180     }
00181 
00182     <span class="keywordflow">return</span> iter;
00183 }
00184 
00185 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri May 13 16:53:36 2005 for HDASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
