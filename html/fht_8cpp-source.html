<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>HDASS: fht.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>fht.cpp</h1><a href="fht_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// FHT - Fast Hartley Transform Class</span>
00002 <span class="comment">//</span>
00003 <span class="comment">// Copyright (C) 2004  Melchior FRANZ - mfranz@kde.org</span>
00004 <span class="comment">//</span>
00005 <span class="comment">// This program is free software; you can redistribute it and/or</span>
00006 <span class="comment">// modify it under the terms of the GNU General Public License as</span>
00007 <span class="comment">// published by the Free Software Foundation; either version 2 of the</span>
00008 <span class="comment">// License, or (at your option) any later version.</span>
00009 <span class="comment">//</span>
00010 <span class="comment">// This program is distributed in the hope that it will be useful, but</span>
00011 <span class="comment">// WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00013 <span class="comment">// General Public License for more details.</span>
00014 <span class="comment">//</span>
00015 <span class="comment">// You should have received a copy of the GNU General Public License</span>
00016 <span class="comment">// along with this program; if not, write to the Free Software</span>
00017 <span class="comment">// Foundation, 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA</span>
00018 <span class="comment">//</span>
00019 <span class="comment">// $Id: fht.cpp,v 1.3 2004/06/05 20:20:36 mfranz Exp $</span>
00020 
00021 <span class="preprocessor">#include &lt;math.h&gt;</span>
00022 <span class="preprocessor">#include &lt;string.h&gt;</span>
00023 <span class="preprocessor">#include "<a class="code" href="fht_8h.html">fht.h</a>"</span>
00024 
00025 
<a name="l00026"></a><a class="code" href="classFHT.html#FHTa0">00026</a> <a class="code" href="classFHT.html#FHTa0">FHT::FHT</a>(<span class="keywordtype">int</span> n) :
00027         m_buf(0),
00028         m_tab(0),
00029         m_log(0)
00030 {
00031         <span class="keywordflow">if</span> (n &lt; 3) {
00032                 <a class="code" href="classFHT.html#FHTr1">m_num</a> = 0;
00033                 <a class="code" href="classFHT.html#FHTr0">m_exp2</a> = -1;
00034                 <span class="keywordflow">return</span>;
00035         }
00036         <a class="code" href="classFHT.html#FHTr0">m_exp2</a> = n;
00037         <a class="code" href="classFHT.html#FHTr1">m_num</a> = 1 &lt;&lt; n;
00038         <span class="keywordflow">if</span> (n &gt; 3) {
00039                 <a class="code" href="classFHT.html#FHTr2">m_buf</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="classFHT.html#FHTr1">m_num</a>];
00040                 <a class="code" href="classFHT.html#FHTr3">m_tab</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="classFHT.html#FHTr1">m_num</a> * 2];
00041                 <a class="code" href="classFHT.html#FHTd0">makeCasTable</a>();
00042         }
00043 }
00044 
00045 
<a name="l00046"></a><a class="code" href="classFHT.html#FHTa1">00046</a> <a class="code" href="classFHT.html#FHTa1">FHT::~FHT</a>()
00047 {
00048         <span class="keyword">delete</span>[] <a class="code" href="classFHT.html#FHTr2">m_buf</a>;
00049         <span class="keyword">delete</span>[] <a class="code" href="classFHT.html#FHTr3">m_tab</a>;
00050         <span class="keyword">delete</span>[] <a class="code" href="classFHT.html#FHTr4">m_log</a>;
00051 }
00052 
00053 
<a name="l00054"></a><a class="code" href="classFHT.html#FHTd0">00054</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTd0">FHT::makeCasTable</a>(<span class="keywordtype">void</span>)
00055 {
00056         <span class="keywordtype">float</span> d, *costab, *sintab;
00057         <span class="keywordtype">int</span> ul, ndiv2 = <a class="code" href="classFHT.html#FHTr1">m_num</a> / 2;
00058 
00059         <span class="keywordflow">for</span> (costab = <a class="code" href="classFHT.html#FHTr3">m_tab</a>, sintab = m_tab + <a class="code" href="classFHT.html#FHTr1">m_num</a> / 2 + 1, ul = 0; ul &lt; <a class="code" href="classFHT.html#FHTr1">m_num</a>; ul++) {
00060                 d = M_PI * ul / ndiv2;
00061                 *costab = *sintab = cos(d);
00062 
00063                 costab += 2, sintab += 2;
00064                 <span class="keywordflow">if</span> (sintab &gt; m_tab + m_num * 2)
00065                         sintab = m_tab + 1;
00066         }
00067 }
00068 
00069 
<a name="l00070"></a><a class="code" href="classFHT.html#FHTa4">00070</a> <span class="keywordtype">float</span>* <a class="code" href="classFHT.html#FHTa4">FHT::copy</a>(<span class="keywordtype">float</span> *d, <span class="keywordtype">float</span> *s)
00071 {
00072         <span class="keywordflow">return</span> (<span class="keywordtype">float</span> *)memcpy(d, s, <a class="code" href="classFHT.html#FHTr1">m_num</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00073 }
00074 
00075 
<a name="l00076"></a><a class="code" href="classFHT.html#FHTa5">00076</a> <span class="keywordtype">float</span>* <a class="code" href="classFHT.html#FHTa5">FHT::clear</a>(<span class="keywordtype">float</span> *d)
00077 {
00078         <span class="keywordflow">return</span> (<span class="keywordtype">float</span> *)memset(d, 0, <a class="code" href="classFHT.html#FHTr1">m_num</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
00079 }
00080 
00081 
<a name="l00082"></a><a class="code" href="classFHT.html#FHTa6">00082</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa6">FHT::scale</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> d)
00083 {
00084         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; (<a class="code" href="classFHT.html#FHTr1">m_num</a> / 2); i++)
00085                 *p++ *= d;
00086 }
00087 
00088 
<a name="l00089"></a><a class="code" href="classFHT.html#FHTa7">00089</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa7">FHT::ewma</a>(<span class="keywordtype">float</span> *d, <span class="keywordtype">float</span> *s, <span class="keywordtype">float</span> w)
00090 {
00091         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; (<a class="code" href="classFHT.html#FHTr1">m_num</a> / 2); i++, d++, s++)
00092                 *d = *d * w + *s * (1 - w);
00093 }
00094 
00095 
<a name="l00096"></a><a class="code" href="fht_8cpp.html#a0">00096</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="fht_8cpp.html#a0">sind</a>(<span class="keywordtype">float</span> d) { <span class="keywordflow">return</span> sin(d * M_PI / 180); }
<a name="l00097"></a><a class="code" href="classFHT.html#FHTa8">00097</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa8">FHT::pattern</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">bool</span> rect = <span class="keyword">false</span>)
00098 {
00099         <span class="keyword">static</span> <span class="keywordtype">float</span> f = 1.0;
00100         <span class="keyword">static</span> <span class="keywordtype">float</span> h = 0.1;
00101         <span class="keywordtype">int</span> i;
00102         <span class="keywordflow">for</span> (i = 0; i &lt; 3 * <a class="code" href="classFHT.html#FHTr1">m_num</a> / 4; i++, p++) {
00103                 <span class="keywordtype">float</span> o = 360.0 * i / <a class="code" href="classFHT.html#FHTr1">m_num</a>;
00104                 *p = <a class="code" href="fht_8cpp.html#a0">sind</a>(f * o);
00105                 <span class="keywordflow">if</span> (rect)
00106                         *p = *p &lt; 0 ? -1.0 : 1.0;
00107         }
00108         <span class="keywordflow">for</span> (; i &lt; <a class="code" href="classFHT.html#FHTr1">m_num</a>; i++)
00109                 *p++ = 0.0;
00110         <span class="keywordflow">if</span> (f &gt; m_num / 2.0 || f &lt; .05)
00111                 h = -h;
00112         f += h;
00113 }
00114 
00115 
<a name="l00116"></a><a class="code" href="classFHT.html#FHTa9">00116</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa9">FHT::logSpectrum</a>(<span class="keywordtype">float</span> *out, <span class="keywordtype">float</span> *p)
00117 {
00118         <span class="keywordtype">int</span> n = <a class="code" href="classFHT.html#FHTr1">m_num</a> / 2, i, j, k, *r;
00119         <span class="keywordflow">if</span> (!<a class="code" href="classFHT.html#FHTr4">m_log</a>) {
00120                 <a class="code" href="classFHT.html#FHTr4">m_log</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[n];
00121                 <span class="keywordtype">float</span> f = n / log10(n);
00122                 <span class="keywordflow">for</span> (i = 0, r = <a class="code" href="classFHT.html#FHTr4">m_log</a>; i &lt; n; i++, r++) {
00123                         j = int(rint(log10(i + 1.0) * f));
00124                         *r = j &gt;= n ? n - 1 : j;
00125                 }
00126         }
00127         <a class="code" href="classFHT.html#FHTa10">semiLogSpectrum</a>(p);
00128         *out++ = *p = *p / 100;
00129         <span class="keywordflow">for</span> (k = i = 1, r = <a class="code" href="classFHT.html#FHTr4">m_log</a>; i &lt; n; i++) {
00130                 j = *r++;
00131                 <span class="keywordflow">if</span> (i == j)
00132                         *out++ = p[i];
00133                 <span class="keywordflow">else</span> {
00134                         <span class="keywordtype">float</span> base = p[k - 1];
00135                         <span class="keywordtype">float</span> step = (p[j] - base) / (j - (k - 1));
00136                         <span class="keywordflow">for</span> (<span class="keywordtype">float</span> corr = 0; k &lt;= j; k++, corr += step)
00137                                 *out++ = base + corr;
00138                 }
00139         }
00140 }
00141 
00142 
<a name="l00143"></a><a class="code" href="classFHT.html#FHTa10">00143</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa10">FHT::semiLogSpectrum</a>(<span class="keywordtype">float</span> *p)
00144 {
00145         <span class="keywordtype">float</span> e;
00146         <a class="code" href="classFHT.html#FHTa13">power2</a>(p);
00147         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; (<a class="code" href="classFHT.html#FHTr1">m_num</a> / 2); i++, p++) {
00148                 e = 10.0 * log10(sqrt(*p * .5));
00149                 *p = e &lt; 0 ? 0 : e;
00150         }
00151 }
00152 
00153 
<a name="l00154"></a><a class="code" href="classFHT.html#FHTa11">00154</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa11">FHT::spectrum</a>(<span class="keywordtype">float</span> *p)
00155 {
00156         <a class="code" href="classFHT.html#FHTa13">power2</a>(p);
00157         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; (<a class="code" href="classFHT.html#FHTr1">m_num</a> / 2); i++, p++)
00158                 *p = (<span class="keywordtype">float</span>)sqrt(*p * .5);
00159 }
00160 
00161 
<a name="l00162"></a><a class="code" href="classFHT.html#FHTa12">00162</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa12">FHT::power</a>(<span class="keywordtype">float</span> *p)
00163 {
00164         <a class="code" href="classFHT.html#FHTa13">power2</a>(p);
00165         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; (<a class="code" href="classFHT.html#FHTr1">m_num</a> / 2); i++)
00166                 *p++ *= .5;
00167 }
00168 
00169 
<a name="l00170"></a><a class="code" href="classFHT.html#FHTa13">00170</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa13">FHT::power2</a>(<span class="keywordtype">float</span> *p)
00171 {
00172         <span class="keywordtype">int</span> i;
00173         <span class="keywordtype">float</span> *q;
00174         <a class="code" href="classFHT.html#FHTd1">_transform</a>(p, <a class="code" href="classFHT.html#FHTr1">m_num</a>, 0);
00175 
00176         *p = (*p * *p), *p += *p, p++;
00177 
00178         <span class="keywordflow">for</span> (i = 1, q = p + <a class="code" href="classFHT.html#FHTr1">m_num</a> - 2; i &lt; (<a class="code" href="classFHT.html#FHTr1">m_num</a> / 2); i++, --q)
00179                 *p++ = (*p * *p) + (*q * *q);
00180 }
00181 
00182 
<a name="l00183"></a><a class="code" href="classFHT.html#FHTa15">00183</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa15">FHT::transform</a>(<span class="keywordtype">float</span> *p)
00184 {
00185         <span class="keywordflow">if</span> (<a class="code" href="classFHT.html#FHTr1">m_num</a> == 8)
00186                 <a class="code" href="classFHT.html#FHTa14">transform8</a>(p);
00187         <span class="keywordflow">else</span>
00188                 <a class="code" href="classFHT.html#FHTd1">_transform</a>(p, <a class="code" href="classFHT.html#FHTr1">m_num</a>, 0);
00189 }
00190 
00191 
<a name="l00192"></a><a class="code" href="classFHT.html#FHTa14">00192</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTa14">FHT::transform8</a>(<span class="keywordtype">float</span> *p)
00193 {
00194         <span class="keywordtype">float</span> a, b, c, d, e, f, g, h, b_f2, d_h2;
00195         <span class="keywordtype">float</span> a_c_eg, a_ce_g, ac_e_g, aceg, b_df_h, bdfh;
00196 
00197         a = *p++, b = *p++, c = *p++, d = *p++;
00198         e = *p++, f = *p++, g = *p++, h = *p;
00199         b_f2 = (b - f) * M_SQRT2;
00200         d_h2 = (d - h) * M_SQRT2;
00201 
00202         a_c_eg = a - c - e + g;
00203         a_ce_g = a - c + e - g;
00204         ac_e_g = a + c - e - g;
00205         aceg = a + c + e + g;
00206 
00207         b_df_h = b - d + f - h;
00208         bdfh = b + d + f + h;
00209 
00210         *p = a_c_eg - d_h2;
00211         *--p = a_ce_g - b_df_h;
00212         *--p = ac_e_g - b_f2;
00213         *--p = aceg - bdfh;
00214         *--p = a_c_eg + d_h2;
00215         *--p = a_ce_g + b_df_h;
00216         *--p = ac_e_g + b_f2;
00217         *--p = aceg + bdfh;
00218 }
00219 
00220 
<a name="l00221"></a><a class="code" href="classFHT.html#FHTd1">00221</a> <span class="keywordtype">void</span> <a class="code" href="classFHT.html#FHTd1">FHT::_transform</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> k)
00222 {
00223         <span class="keywordflow">if</span> (n == 8) {
00224                 <a class="code" href="classFHT.html#FHTa14">transform8</a>(p + k);
00225                 <span class="keywordflow">return</span>;
00226         }
00227 
00228         <span class="keywordtype">int</span> i, j, ndiv2 = n / 2;
00229         <span class="keywordtype">float</span> a, *t1, *t2, *t3, *t4, *ptab, *pp;
00230 
00231         <span class="keywordflow">for</span> (i = 0, t1 = <a class="code" href="classFHT.html#FHTr2">m_buf</a>, t2 = m_buf + ndiv2, pp = &amp;p[k]; i &lt; ndiv2; i++)
00232                 *t1++ = *pp++, *t2++ = *pp++;
00233 
00234         memcpy(p + k, m_buf, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * n);
00235 
00236         <a class="code" href="classFHT.html#FHTd1">_transform</a>(p, ndiv2, k);
00237         <a class="code" href="classFHT.html#FHTd1">_transform</a>(p, ndiv2, k + ndiv2);
00238 
00239         j = <a class="code" href="classFHT.html#FHTr1">m_num</a> / ndiv2 - 1;
00240         t1 = m_buf;
00241         t2 = t1 + ndiv2;
00242         t3 = p + k + ndiv2;
00243         ptab = <a class="code" href="classFHT.html#FHTr3">m_tab</a>;
00244         pp = p + k;
00245 
00246         a = *ptab++ * *t3++;
00247         a += *ptab * *pp;
00248         ptab += j;
00249 
00250         *t1++ = *pp + a;
00251         *t2++ = *pp++ - a;
00252 
00253         <span class="keywordflow">for</span> (i = 1, t4 = p + k + n; i &lt; ndiv2; i++, ptab += j) {
00254                 a = *ptab++ * *t3++;
00255                 a += *ptab * *--t4;
00256 
00257                 *t1++ = *pp + a;
00258                 *t2++ = *pp++ - a;
00259         }
00260         memcpy(p + k, m_buf, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * n);
00261 }
00262 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri May 13 16:53:35 2005 for HDASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
