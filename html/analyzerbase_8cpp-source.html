<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>HDASS: analyzerbase.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>analyzerbase.cpp</h1><a href="analyzerbase_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">                          viswidget.cpp  -  description</span>
00003 <span class="comment">                             -------------------</span>
00004 <span class="comment">    begin                : Die Jan 7 2003</span>
00005 <span class="comment">    copyright            : (C) 2003 by Max Howell</span>
00006 <span class="comment">    email                : markey@web.de</span>
00007 <span class="comment"> ***************************************************************************/</span>
00008 
00009 <span class="comment">/***************************************************************************</span>
00010 <span class="comment"> *                                                                         *</span>
00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
00012 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
00013 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
00014 <span class="comment"> *   (at your option) any later version.                                   *</span>
00015 <span class="comment"> *                                                                         *</span>
00016 <span class="comment"> ***************************************************************************/</span>
00017 
00018 <span class="preprocessor">#include "<a class="code" href="analyzerbase_8h.html">analyzerbase.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="enginebase_8h.html">enginebase.h</a>"</span> <span class="comment">//engine-&gt;state()</span>
00020 <span class="preprocessor">#include "<a class="code" href="enginecontroller_8h.html">enginecontroller.h</a>"</span>
00021 <span class="preprocessor">#include &lt;math.h&gt;</span>       <span class="comment">//interpolate()</span>
00022 <span class="preprocessor">#include &lt;qevent.h&gt;</span>     <span class="comment">//event()</span>
00023 
00024 <span class="preprocessor">#ifdef DRAW_GRID</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include &lt;qpainter.h&gt;</span>
00026 <span class="preprocessor">#include &lt;qpen.h&gt;</span>
00027 <span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 <span class="comment">// INSTRUCTIONS Base2D</span>
00030 <span class="comment">// 1. do anything that depends on height() in init(), Base2D will call it before you are shown</span>
00031 <span class="comment">// 2. otherwise you can use the constructor to initialise things</span>
00032 <span class="comment">// 3. reimplement analyze(), and paint to canvas(), Base2D will update the widget when you return control to it</span>
00033 <span class="comment">// 4. if you want to manipulate the scope, reimplement transform()</span>
00034 <span class="comment">// 5. for convenience &lt;vector&gt; &lt;qpixmap.h&gt; &lt;qwdiget.h&gt; are pre-included</span>
00035 <span class="comment">// TODO make an INSTRUCTIONS file</span>
00036 <span class="comment">//can't mod scope in analyze you have to use transform</span>
00037 
00038 
00039 <span class="comment">//TODO for 2D use setErasePixmap Qt function insetead of m_background</span>
00040 
00041 
00042 <span class="keyword">template</span>&lt;<span class="keyword">class</span> W&gt;
<a name="l00043"></a><a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb0">00043</a> <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb0">Analyzer::Base&lt;W&gt;::Base</a>( <a class="code" href="classQWidget.html">QWidget</a> *parent, uint timeout, uint scopeSize )
00044   : W( parent )
00045   , m_timeout( timeout )
00046   , m_height( 0 )
00047   , m_fht( scopeSize )
00048 {}
00049 
00050 <span class="keyword">template</span>&lt;<span class="keyword">class</span> W&gt; <span class="keywordtype">bool</span>
<a name="l00051"></a><a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Based0">00051</a> <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Based0">Analyzer::Base&lt;W&gt;::event</a>( QEvent *e )
00052 {
00053     <span class="keywordflow">switch</span>( e-&gt;type() ) {
00054 <span class="comment">/*    case QEvent::Paint:</span>
00055 <span class="comment">        if( !canvas()-&gt;isNull() )</span>
00056 <span class="comment">            bitBlt( this, 0, 0, canvas() );</span>
00057 <span class="comment">        return true; //no propagate event*/</span>
00058     <span class="keywordflow">case</span> QEvent::Hide:
00059         <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basep0">m_timer</a>.stop();
00060         <span class="keywordflow">break</span>;
00061 
00062     <span class="keywordflow">case</span> QEvent::Show:
00063         <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basep0">m_timer</a>.start( <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basea0">timeout</a>() );
00064         <span class="keywordflow">break</span>;
00065 
00066     <span class="keywordflow">default</span>:
00067         <span class="keywordflow">break</span>;
00068     }
00069 
00070     <span class="keywordflow">return</span> QWidget::event( e );
00071 }
00072 
00073 <span class="keyword">template</span>&lt;<span class="keyword">class</span> W&gt; <span class="keywordtype">void</span>
<a name="l00074"></a><a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb2">00074</a> <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb2">Analyzer::Base&lt;W&gt;::transform</a>( <a class="code" href="namespaceAnalyzer.html#a0">Scope</a> &amp;scope ) <span class="comment">//virtual</span>
00075 {
00076     <span class="comment">//this is a standard transformation that should give</span>
00077     <span class="comment">//an FFT scope that has bands for pretty analyzers</span>
00078 
00079     <span class="comment">//NOTE resizing here is redundant as FHT routines only calculate FHT::size() values</span>
00080     <span class="comment">//scope.resize( m_fht.size() );</span>
00081 
00082     <span class="keywordtype">float</span> *front = static_cast&lt;float*&gt;( &amp;scope.front() );
00083 
00084     <span class="keywordtype">float</span>* f = <span class="keyword">new</span> <span class="keywordtype">float</span>[ <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basep3">m_fht</a>.<a class="code" href="classFHT.html#FHTa3">size</a>() ];
00085     <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basep3">m_fht</a>.<a class="code" href="classFHT.html#FHTa4">copy</a>( &amp;f[0], front );
00086     <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basep3">m_fht</a>.<a class="code" href="classFHT.html#FHTa9">logSpectrum</a>( front, &amp;f[0] );
00087     <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basep3">m_fht</a>.<a class="code" href="classFHT.html#FHTa6">scale</a>( front, 1.0 / 20 );
00088 
00089     scope.resize( <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basep3">m_fht</a>.<a class="code" href="classFHT.html#FHTa3">size</a>()/2 ); <span class="comment">//second half of values are rubbish</span>
00090     <span class="keyword">delete</span> [] f;
00091 }
00092 
00093 <span class="keyword">template</span>&lt;<span class="keyword">class</span> W&gt; <span class="keywordtype">void</span>
<a name="l00094"></a><a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb1">00094</a> <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb1">Analyzer::Base&lt;W&gt;::drawFrame</a>()
00095 {
00096     <a class="code" href="classEngineBase.html">EngineBase</a> *engine = <a class="code" href="classEngineController.html#EngineControllere1">EngineController::engine</a>();
00097 
00098     <span class="keywordflow">switch</span>( engine-&gt;<a class="code" href="classEngineBase.html#EngineBasea8">state</a>() )
00099     {
00100     <span class="keywordflow">case</span> EngineBase::Playing:
00101     {
00102         <a class="code" href="namespaceAnalyzer.html#a0">Scope</a> *scope = engine-&gt;<a class="code" href="classEngineBase.html#EngineBasea14">scope</a>();
00103 
00104         <span class="keywordflow">if</span>( !scope-&gt;empty() )
00105         {
00106             <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb2">transform</a>( *scope );
00107             <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb3">analyze</a>( *scope );
00108         }
00109 
00110         <span class="keyword">delete</span> scope;
00111 
00112         <span class="keywordflow">break</span>;
00113     }
00114     <span class="keywordflow">case</span> EngineBase::Paused:
00115         <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb4">paused</a>();
00116         <span class="keywordflow">break</span>;
00117 
00118     <span class="keywordflow">default</span>:
00119         <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb5">demo</a>();
00120     }
00121 }
00122 
00123 <span class="keyword">template</span>&lt;<span class="keyword">class</span> W&gt; <span class="keywordtype">void</span>
<a name="l00124"></a><a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb4">00124</a> <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb4">Analyzer::Base&lt;W&gt;::paused</a>() <span class="comment">//virtual</span>
00125 {}
00126 
00127 <span class="keyword">template</span>&lt;<span class="keyword">class</span> W&gt; <span class="keywordtype">void</span>
<a name="l00128"></a><a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb5">00128</a> <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb5">Analyzer::Base&lt;W&gt;::demo</a>() <span class="comment">//virtual</span>
00129 {
00130     <span class="keyword">static</span> <span class="keywordtype">int</span> t = 201; <span class="comment">//FIXME make static to namespace perhaps</span>
00131 
00132     <span class="keywordflow">if</span>( t &gt; 999 ) t = 1; <span class="comment">//0 = wasted calculations</span>
00133     <span class="keywordflow">if</span>( t &lt; 201 )
00134     {
00135         <a class="code" href="namespaceAnalyzer.html#a0">Scope</a> s( 32 );
00136 
00137         <span class="keyword">const</span> <span class="keywordtype">double</span> dt = double(t) / 200;
00138         <span class="keywordflow">for</span>( uint i = 0; i &lt; s.size(); ++i )
00139             s[i] = dt * (sin( M_PI + (i * M_PI) / s.size() ) + 1.0);
00140 
00141         <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb3">analyze</a>( s );
00142     }
00143     <span class="keywordflow">else</span> <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Baseb3">analyze</a>( <a class="code" href="namespaceAnalyzer.html#a0">Scope</a>( 32, 0 ) );
00144 
00145     ++t;
00146 }
00147 
00148 
00149 
<a name="l00150"></a><a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Db0">00150</a> <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Db0">Analyzer::Base2D::Base2D</a>( <a class="code" href="classQWidget.html">QWidget</a> *parent, uint timeout, uint scopeSize )
00151    : <a class="code" href="classAnalyzer_1_1Base.html">Base</a>&lt;<a class="code" href="classQWidget.html">QWidget</a>&gt;( parent, timeout, scopeSize )
00152 {
00153     setWFlags( Qt::WNoAutoErase ); <span class="comment">//no flicker</span>
00154 
00155     connect( &amp;m_timer, SIGNAL( <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basea0">timeout</a>() ), SLOT( <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dk0">draw</a>() ) );
00156 }
00157 
00158 <span class="keywordtype">void</span>
<a name="l00159"></a><a class="code" href="classAnalyzer_1_1Base2D.html#Sonogramb5">00159</a> <a class="code" href="classAnalyzer_1_1Base2D.html#Sonogramb5">Analyzer::Base2D::polish</a>()
00160 {
00161     <span class="comment">//TODO is there much point in this anymore?</span>
00162 
00163     <span class="comment">//we use polish for initialzing (instead of ctor)</span>
00164     <span class="comment">//because we need to know the widget's final size</span>
00165     QWidget::polish();
00166 
00167     <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Db1">init</a>(); <span class="comment">//virtual</span>
00168 }
00169 
00170 <span class="keywordtype">void</span>
<a name="l00171"></a><a class="code" href="classAnalyzer_1_1Base2D.html#Sonogramb3">00171</a> <a class="code" href="classAnalyzer_1_1Base2D.html#Sonogramb3">Analyzer::Base2D::resizeEvent</a>( QResizeEvent *e )
00172 {
00173     m_height = QWidget::height();
00174     <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr0">m_background</a>.resize( size() );
00175     <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr1">m_canvas</a>.resize( size() );
00176 
00177 <span class="preprocessor">    #ifdef DRAW_GRID</span>
00178 <span class="preprocessor"></span>    QPainter p( &amp;<a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr0">m_background</a> );
00179     p.setPen( QColor( 0x20, 0x20, 0x50 ) );
00180 
00181     <span class="keywordflow">for</span>( uint x = 0, w = <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr0">m_background</a>.width(), h = <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr0">m_background</a>.height()-1;
00182         x &lt; w; x += 3 ) p.drawLine( x, 0, x, h );
00183     <span class="keywordflow">for</span>( uint y = 0, w = <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr0">m_background</a>.width()-1 , h = <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr0">m_background</a>.height();
00184         y &lt; h; y += 3 ) p.drawLine( 0, y, w, y );
00185 <span class="preprocessor">    #else</span>
00186 <span class="preprocessor"></span>    <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dr0">m_background</a>.fill( backgroundColor() );
00187 <span class="preprocessor">    #endif</span>
00188 <span class="preprocessor"></span>
00189     <a class="code" href="classAnalyzer_1_1Base2D.html#Sonogramb1">eraseCanvas</a>(); <span class="comment">//this is necessary</span>
00190 
00191     QWidget::resizeEvent( e );
00192 }
00193 
00194 <span class="keywordtype">void</span>
00195 <a class="code" href="classAnalyzer_1_1Base2D.html#Sonogramb4">Analyzer::Base2D::paletteChange</a>( <span class="keyword">const</span> QPalette&amp; )
00196 {
00197     m_background.fill( backgroundColor() );
00198     <a class="code" href="classAnalyzer_1_1Base2D.html#Sonogramb1">eraseCanvas</a>();
00199 }
00200 
00201 
00202 
00203 <span class="preprocessor">#ifdef HAVE_QGLWIDGET</span>
00204 <span class="preprocessor"></span><a class="code" href="classAnalyzer_1_1Base3D.html#Analyzer_1_1Base3Db0">Analyzer::Base3D::Base3D</a>( <a class="code" href="classQWidget.html">QWidget</a> *parent, uint timeout, uint scopeSize )
00205    : Base&lt;<a class="code" href="classQGLWidget.html">QGLWidget</a>&gt;( parent, timeout, scopeSize )
00206 {
00207     connect( &amp;m_timer, SIGNAL( <a class="code" href="classAnalyzer_1_1Base.html#Analyzer_1_1Basea0">timeout</a>() ), SLOT( <a class="code" href="classAnalyzer_1_1Base2D.html#Analyzer_1_1Base2Dk0">draw</a>() ) );
00208 }
00209 <span class="preprocessor">#endif</span>
00210 <span class="preprocessor"></span>
00211 
00212 <span class="keywordtype">void</span>
<a name="l00213"></a><a class="code" href="namespaceAnalyzer.html#a1">00213</a> <a class="code" href="namespaceAnalyzer.html#a1">Analyzer::interpolate</a>( <span class="keyword">const</span> <a class="code" href="namespaceAnalyzer.html#a0">Scope</a> &amp;inVec, <a class="code" href="namespaceAnalyzer.html#a0">Scope</a> &amp;outVec ) <span class="comment">//static</span>
00214 {
00215     <span class="keywordtype">double</span> pos = 0.0;
00216     <span class="keyword">const</span> <span class="keywordtype">double</span> step = (<span class="keywordtype">double</span>)inVec.size() / outVec.size();
00217 
00218     <span class="keywordflow">for</span> ( uint i = 0; i &lt; outVec.size(); ++i, pos += step )
00219     {
00220         <span class="keyword">const</span> <span class="keywordtype">double</span> error = pos - floor( pos );
00221         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> offset = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)pos;
00222 
00223         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> indexLeft = offset + 0;
00224 
00225         <span class="keywordflow">if</span> ( indexLeft &gt;= inVec.size() )
00226             indexLeft = inVec.size() - 1;
00227 
00228         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> indexRight = offset + 1;
00229 
00230         <span class="keywordflow">if</span> ( indexRight &gt;= inVec.size() )
00231             indexRight = inVec.size() - 1;
00232 
00233         outVec[i] = inVec[indexLeft ] * ( 1.0 - error ) +
00234                     inVec[indexRight] * error;
00235     }
00236 }
00237 
00238 <span class="keywordtype">void</span>
<a name="l00239"></a><a class="code" href="namespaceAnalyzer.html#a2">00239</a> <a class="code" href="namespaceAnalyzer.html#a2">Analyzer::initSin</a>( <a class="code" href="namespaceAnalyzer.html#a0">Scope</a> &amp;v, <span class="keyword">const</span> uint size ) <span class="comment">//static</span>
00240 {
00241     <span class="keywordtype">double</span> step = ( M_PI * 2 ) / size;
00242     <span class="keywordtype">double</span> radian = 0;
00243 
00244     <span class="keywordflow">for</span> ( uint i = 0; i &lt; size; i++ )
00245     {
00246         v.push_back( sin( radian ) );
00247         radian += step;
00248     }
00249 }
00250 
00251 <span class="preprocessor">#include "<a class="code" href="analyzerbase_8moc.html">analyzerbase.moc</a>"</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri May 13 16:53:34 2005 for HDASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
