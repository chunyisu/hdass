<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>HDASS: metabundle.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>metabundle.cpp</h1><a href="metabundle_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">//Maintainer: Max Howell &lt;max.howell@methylblue.com&gt;, (C) 2004</span>
00002 <span class="comment">//Copyright:  See COPYING file that comes with this distribution</span>
00003 <span class="comment">//</span>
00004 
00005 <span class="preprocessor">#include "<a class="code" href="metabundle_8h.html">metabundle.h</a>"</span>
00006 <span class="comment">//#include "playlistitem.h"</span>
00007 
00008 <span class="preprocessor">#include &lt;qstring.h&gt;</span>
00009 
00010 <span class="preprocessor">#include &lt;kfilemetainfo.h&gt;</span>
00011 <span class="preprocessor">#include &lt;kdebug.h&gt;</span>
00012 
00013 <span class="preprocessor">#include &lt;taglib/tag.h&gt;</span>
00014 <span class="preprocessor">#include &lt;taglib/fileref.h&gt;</span>
00015 <span class="preprocessor">#include &lt;taglib/tstring.h&gt;</span>
00016 <span class="preprocessor">#include &lt;taglib/audioproperties.h&gt;</span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * This class is not very complete, it fits our needs as they stand currently</span>
00020 <span class="comment"> * If it doesn't work for you in some way, extend it sensibly :)</span>
00021 <span class="comment"> */</span>
00022 
00023 
00024  <span class="comment">//FIXME these aren't i18n'd</span>
00025  <span class="comment">//the point here is to force sharing of these strings returned from prettyBitrate()</span>
<a name="l00026"></a><a class="code" href="metabundle_8cpp.html#a0">00026</a> <span class="keyword">static</span> <span class="keyword">const</span> QString <a class="code" href="metabundle_8cpp.html#a0">bitrateStore</a>[9] = { <span class="stringliteral">"?"</span>, <span class="stringliteral">"32 kbps"</span>, <span class="stringliteral">"64 kbps"</span>, <span class="stringliteral">"96 kbps"</span>, <span class="stringliteral">"128 kbps"</span>, <span class="stringliteral">"160 kbps"</span>, <span class="stringliteral">"192 kbps"</span>, <span class="stringliteral">"224 kbps"</span>, <span class="stringliteral">"256 kbps"</span> };
00027 
00028 <span class="comment">//TODO consider the worth of this extension; use trackStore.ref( i )</span>
00029 <span class="comment">//static const QString trackStore = "0123456789";</span>
00030 
00031 
00032 <span class="comment">//TODO one without audioProps please</span>
00033 <span class="comment">//TODO have ability to determine bitrate etc from the strings, slow but infrequently called so ok</span>
00034 <span class="comment">//TODO cache prettyLength for bundles</span>
00035 <span class="comment">//TODO is it feasible to just use a TagLib::AudioProperties structure?</span>
00036 
00037 
00038 <span class="comment">//TitleProxy ctor</span>
<a name="l00039"></a><a class="code" href="classMetaBundle.html#MetaBundlea2">00039</a> <a class="code" href="classMetaBundle.html#MetaBundlea0">MetaBundle::MetaBundle</a>( <span class="keyword">const</span> QString&amp; title,
00040                         <span class="keyword">const</span> QString&amp; streamUrl,
00041                         <span class="keyword">const</span> <span class="keywordtype">int</span>      bitrate,
00042                         <span class="keyword">const</span> QString&amp; genre,
00043                         <span class="keyword">const</span> QString&amp; <span class="comment">/*streamName*/</span>,
00044                         <span class="keyword">const</span> KURL&amp; url )
00045   : m_url       ( url )
00046   , m_title     ( streamUrl + QString( " -- " ) + title )
00047   , m_genre     ( genre )
00048   , m_bitrate   ( bitrate )
00049   , m_length    ( Irrelevant )
00050   , m_sampleRate( Unavailable )
00051   ,exists(false)
00052 {
00053 kdDebug() &lt;&lt; <span class="stringliteral">"Test point 1 "</span> &lt;&lt; endl;
00054 }
00055 
00056 <span class="comment">/*//PlaylistItem ctor</span>
00057 <span class="comment">MetaBundle::MetaBundle( const PlaylistItem *item )</span>
00058 <span class="comment">  : m_url    ( item-&gt;url() )</span>
00059 <span class="comment">  , m_title  ( item-&gt;title() )        //because you override text()</span>
00060 <span class="comment">  , m_artist ( item-&gt;exactText( 2 ) ) //because you override text()</span>
00061 <span class="comment">  , m_album  ( item-&gt;exactText( 3 ) ) //etc.</span>
00062 <span class="comment">  , m_year   ( item-&gt;exactText( 4 ) ) //..</span>
00063 <span class="comment">  , m_comment( item-&gt;exactText( 5 ) ) //.</span>
00064 <span class="comment">  , m_genre  ( item-&gt;exactText( 6 ) )</span>
00065 <span class="comment">  , m_track  ( item-&gt;exactText( 7 ) )</span>
00066 <span class="comment">{</span>
00067 <span class="comment">    if( m_url.isLocalFile() )</span>
00068 <span class="comment">    {</span>
00069 <span class="comment">        TagLib::FileRef f( m_url.path().local8Bit(), true, TagLib::AudioProperties::Accurate );</span>
00070 <span class="comment"></span>
00071 <span class="comment">        if ( f.isNull() )</span>
00072 <span class="comment">        {</span>
00073 <span class="comment">            KFileMetaInfo info( m_url, QString::null, KFileMetaInfo::Everything );</span>
00074 <span class="comment"></span>
00075 <span class="comment">            if ( info.isValid() )</span>
00076 <span class="comment">            {</span>
00077 <span class="comment">                m_bitrate    = info.item( "Bitrate" ).value().toInt();</span>
00078 <span class="comment">                m_length     = info.item( "Length" ).value().toInt();</span>
00079 <span class="comment">                m_sampleRate = info.item( "Sample Rate" ).value().toInt();</span>
00080 <span class="comment">            }</span>
00081 <span class="comment">            else init( 0 );</span>
00082 <span class="comment">        }</span>
00083 <span class="comment">        else init( f.audioProperties() );</span>
00084 <span class="comment"></span>
00085 <span class="comment">    } else { //is Stream</span>
00086 <span class="comment"></span>
00087 <span class="comment">        //FIXME not correct handling, say is ftp://file</span>
00088 <span class="comment">        m_bitrate    = item-&gt;exactText( 10 ).left( 3 ).toInt();</span>
00089 <span class="comment">        m_sampleRate = Undetermined;</span>
00090 <span class="comment">        m_length     = Unavailable;</span>
00091 <span class="comment">    }</span>
00092 <span class="comment">}</span>
00093 <span class="comment">*/</span>
00094 
00095 <span class="comment">//Taglib::Tag ctor //TODO DEPRECATE</span>
<a name="l00096"></a><a class="code" href="classMetaBundle.html#MetaBundlea3">00096</a> <a class="code" href="classMetaBundle.html#MetaBundlea0">MetaBundle::MetaBundle</a>( <span class="keyword">const</span> KURL &amp;url, TagLib::Tag *tag, TagLib::AudioProperties *ap )
00097   : m_url( url )
00098   , m_title(   TStringToQString( tag-&gt;title() ).stripWhiteSpace() )
00099   , m_artist(  TStringToQString( tag-&gt;artist() ).stripWhiteSpace() )
00100   , m_album(   TStringToQString( tag-&gt;album() ).stripWhiteSpace() )
00101   , m_year(    tag-&gt;year() ? QString::number( tag-&gt;year() ) : QString::null )
00102   , m_comment( TStringToQString( tag-&gt;comment() ).stripWhiteSpace() )
00103   , m_genre(   TStringToQString( tag-&gt;genre() ).stripWhiteSpace() )
00104   , m_track(   tag-&gt;track() ? QString::number( tag-&gt;track() ) : QString::null )
00105   ,exists(false)
00106 {
00107 kdDebug() &lt;&lt; <span class="stringliteral">"Test point 2 "</span> &lt;&lt; endl;
00108     <a class="code" href="classMetaBundle.html#MetaBundled0">init</a>( ap );
00109 }
00110 
00111 <span class="keywordtype">void</span>
<a name="l00112"></a><a class="code" href="classMetaBundle.html#MetaBundled0">00112</a> <a class="code" href="classMetaBundle.html#MetaBundled0">MetaBundle::init</a>( TagLib::AudioProperties *ap )
00113 {
00114     <span class="keywordflow">if</span>( !<a class="code" href="classMetaBundle.html#MetaBundler0">m_url</a>.isLocalFile() )
00115      {
00116         <a class="code" href="classMetaBundle.html#MetaBundler11">exists</a>=<span class="keyword">false</span>;    
00117         <span class="keywordflow">return</span>;
00118     }   
00119     <span class="keywordflow">if</span>( ap )
00120     {
00121         <a class="code" href="classMetaBundle.html#MetaBundler8">m_bitrate</a>    = ap-&gt;bitrate();
00122         <a class="code" href="classMetaBundle.html#MetaBundler9">m_length</a>     = ap-&gt;length();
00123         <a class="code" href="classMetaBundle.html#MetaBundler10">m_sampleRate</a> = ap-&gt;sampleRate();
00124     }
00125     <span class="keywordflow">else</span> <a class="code" href="classMetaBundle.html#MetaBundler8">m_bitrate</a> = <a class="code" href="classMetaBundle.html#MetaBundler9">m_length</a> = <a class="code" href="classMetaBundle.html#MetaBundler10">m_sampleRate</a> = <a class="code" href="classMetaBundle.html#MetaBundles0">Undetermined</a>;
00126     <a class="code" href="classMetaBundle.html#MetaBundler11">exists</a>=<span class="keyword">true</span>;
00127 }
00128 
00129 <span class="keywordtype">void</span>
<a name="l00130"></a><a class="code" href="classMetaBundle.html#MetaBundled1">00130</a> <a class="code" href="classMetaBundle.html#MetaBundled0">MetaBundle::init</a>( <span class="keyword">const</span> KFileMetaInfo&amp; info )
00131 {
00132     <span class="keywordflow">if</span>( info.isValid() )
00133     {
00134         <a class="code" href="classMetaBundle.html#MetaBundler11">exists</a>=<span class="keyword">true</span>;
00135         <a class="code" href="classMetaBundle.html#MetaBundler2">m_artist</a>     = info.item( <span class="stringliteral">"Artist"</span> ).string();
00136         <a class="code" href="classMetaBundle.html#MetaBundler3">m_album</a>      = info.item( <span class="stringliteral">"Album"</span> ).string();
00137         <a class="code" href="classMetaBundle.html#MetaBundler4">m_year</a>       = info.item( <span class="stringliteral">"Year"</span> ).string();
00138         <a class="code" href="classMetaBundle.html#MetaBundler5">m_comment</a>    = info.item( <span class="stringliteral">"Comment"</span> ).string();
00139         <a class="code" href="classMetaBundle.html#MetaBundler6">m_genre</a>      = info.item( <span class="stringliteral">"Genre"</span> ).string();
00140         <a class="code" href="classMetaBundle.html#MetaBundler7">m_track</a>      = info.item( <span class="stringliteral">"Track"</span> ).string();
00141         <a class="code" href="classMetaBundle.html#MetaBundler8">m_bitrate</a>    = info.item( <span class="stringliteral">"Bitrate"</span> ).value().toInt();
00142         <a class="code" href="classMetaBundle.html#MetaBundler9">m_length</a>     = info.item( <span class="stringliteral">"Length"</span> ).value().toInt();
00143         <a class="code" href="classMetaBundle.html#MetaBundler10">m_sampleRate</a> = info.item( <span class="stringliteral">"Sample Rate"</span> ).value().toInt();
00144 
00145         <span class="comment">/*</span>
00146 <span class="comment">         * For title, check if it is valid. If not, use prettyTitle.</span>
00147 <span class="comment">         * See bug#83650.</span>
00148 <span class="comment">         */</span>
00149         KFileMetaInfoItem item = info.item( <span class="stringliteral">"Title"</span> );
00150         <span class="keywordflow">if</span>( item.isValid() )
00151             <a class="code" href="classMetaBundle.html#MetaBundler1">m_title</a> = item.string();
00152         <span class="keywordflow">else</span>
00153             <a class="code" href="classMetaBundle.html#MetaBundler1">m_title</a> = <a class="code" href="classMetaBundle.html#MetaBundlea17">prettyTitle</a>( <a class="code" href="classMetaBundle.html#MetaBundler0">m_url</a>.fileName() );
00154     }
00155     <span class="keywordflow">else</span> <a class="code" href="classMetaBundle.html#MetaBundler8">m_bitrate</a> = <a class="code" href="classMetaBundle.html#MetaBundler9">m_length</a> = <a class="code" href="classMetaBundle.html#MetaBundler10">m_sampleRate</a> = <a class="code" href="classMetaBundle.html#MetaBundles0">Undetermined</a>;
00156 }
00157 
00158 <a class="code" href="classMetaBundle.html">MetaBundle</a>&amp;
<a name="l00159"></a><a class="code" href="classMetaBundle.html#MetaBundlea4">00159</a> <a class="code" href="classMetaBundle.html#MetaBundlea4">MetaBundle::readTags</a>( <span class="keywordtype">bool</span> audioProperties )
00160 {
00161     <span class="comment">//TODO detect mimetype and use specfic reader like Scott recommends</span>
00162 
00163    TagLib::FileRef f( <a class="code" href="classMetaBundle.html#MetaBundler0">m_url</a>.path().local8Bit(), audioProperties, TagLib::AudioProperties::Fast );
00164 
00165    <span class="keywordflow">if</span> ( !f.isNull() )
00166    {
00167         <span class="keywordflow">if</span>( f.tag() )
00168         {
00169             TagLib::Tag *tag = f.tag();
00170 
00171             <a class="code" href="classMetaBundle.html#MetaBundler1">m_title</a>   = TStringToQString( tag-&gt;title() ).stripWhiteSpace();
00172             <a class="code" href="classMetaBundle.html#MetaBundler2">m_artist</a>  = TStringToQString( tag-&gt;artist() ).stripWhiteSpace();
00173             <a class="code" href="classMetaBundle.html#MetaBundler3">m_album</a>   = TStringToQString( tag-&gt;album() ).stripWhiteSpace();
00174             <a class="code" href="classMetaBundle.html#MetaBundler5">m_comment</a> = TStringToQString( tag-&gt;comment() ).stripWhiteSpace();
00175             <a class="code" href="classMetaBundle.html#MetaBundler6">m_genre</a>   = TStringToQString( tag-&gt;genre() ).stripWhiteSpace();
00176             <a class="code" href="classMetaBundle.html#MetaBundler4">m_year</a>    = tag-&gt;year() ? QString::number( tag-&gt;year() ) : QString::null;
00177             <a class="code" href="classMetaBundle.html#MetaBundler7">m_track</a>   = tag-&gt;track() ? QString::number( tag-&gt;track() ) : QString::null;
00178         }
00179         <a class="code" href="classMetaBundle.html#MetaBundled0">init</a>( f.audioProperties() );
00180     }
00181     <span class="keywordflow">else</span> <a class="code" href="classMetaBundle.html#MetaBundled0">init</a>( KFileMetaInfo( <a class="code" href="classMetaBundle.html#MetaBundler0">m_url</a>, QString::null, KFileMetaInfo::Everything ) );
00182 
00183     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00184 }
00185 
00186 QString
<a name="l00187"></a><a class="code" href="classMetaBundle.html#MetaBundlea17">00187</a> <a class="code" href="classMetaBundle.html#MetaBundlea17">MetaBundle::prettyTitle</a>()<span class="keyword"> const</span>
00188 <span class="keyword"></span>{
00189     <span class="comment">//NOTE this gets regressed often, please be careful!</span>
00190     <span class="comment">//NOTE whatever you do, handle the stream case, streams have no artist but have an excellent title</span>
00191 
00192     QString s = <a class="code" href="classMetaBundle.html#MetaBundler2">m_artist</a>;
00193     <span class="keywordflow">if</span>( !s.isEmpty() ) s += <span class="stringliteral">" - "</span>;
00194     s += <a class="code" href="classMetaBundle.html#MetaBundler1">m_title</a>;
00195     <span class="keywordflow">if</span>( s.isEmpty() ) s = <a class="code" href="classMetaBundle.html#MetaBundlea17">prettyTitle</a>( <a class="code" href="classMetaBundle.html#MetaBundler0">m_url</a>.fileName() );
00196     <span class="keywordflow">return</span> s;
00197 }
00198 
00199 QString
<a name="l00200"></a><a class="code" href="classMetaBundle.html#MetaBundlee4">00200</a> <a class="code" href="classMetaBundle.html#MetaBundlea17">MetaBundle::prettyTitle</a>( QString filename ) <span class="comment">//static</span>
00201 {
00202     QString &amp;s = filename; <span class="comment">//just so the code is more readable</span>
00203 
00204     <span class="comment">//remove file extension, s/_/ /g and decode %2f-like sequences</span>
00205     s = s.left( s.findRev( <span class="charliteral">'.'</span> ) ).replace( <span class="charliteral">'_'</span>, <span class="charliteral">' '</span> );
00206     s = KURL::decode_string(s);
00207 
00208     <span class="keywordflow">return</span> s;
00209 }
00210 
00211 QString
<a name="l00212"></a><a class="code" href="classMetaBundle.html#MetaBundlee1">00212</a> <a class="code" href="classMetaBundle.html#MetaBundlea20">MetaBundle::prettyLength</a>( <span class="keywordtype">int</span> seconds ) <span class="comment">//static</span>
00213 {
00214     QString s;
00215 
00216     <span class="keywordflow">if</span>( seconds &gt; 0 ) s = <a class="code" href="classMetaBundle.html#MetaBundlee2">prettyTime</a>( seconds, <span class="keyword">false</span> );
00217     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( seconds == <a class="code" href="classMetaBundle.html#MetaBundles2">Unavailable</a> ) s = <span class="charliteral">'?'</span>;
00218     <span class="keywordflow">else</span> <span class="keywordflow">if</span>( seconds == <a class="code" href="classMetaBundle.html#MetaBundles1">Irrelevant</a>  ) s = <span class="charliteral">'-'</span>;
00219 
00220     <span class="keywordflow">return</span> s; <span class="comment">//Undetermined = ""</span>
00221 }
00222 
00223 QString
<a name="l00224"></a><a class="code" href="classMetaBundle.html#MetaBundlee2">00224</a> <a class="code" href="classMetaBundle.html#MetaBundlee2">MetaBundle::prettyTime</a>( <span class="keywordtype">int</span> seconds, <span class="keywordtype">bool</span> showHours ) <span class="comment">//static</span>
00225 {
00226     QString s = QChar( <span class="charliteral">':'</span> );
00227     s.append( <a class="code" href="classMetaBundle.html#MetaBundlee3">zeroPad</a>( seconds % 60 ) ); <span class="comment">//seconds</span>
00228     seconds /= 60;
00229 
00230     <span class="keywordflow">if</span>( showHours )
00231     {
00232         s.prepend( <a class="code" href="classMetaBundle.html#MetaBundlee3">zeroPad</a>( seconds % 60 ) ); <span class="comment">//minutes</span>
00233         s.prepend( <span class="charliteral">':'</span> );
00234         seconds /= 60;
00235     }
00236 
00237     <span class="comment">//don't zeroPad the last one, as it can be greater than 2 digits</span>
00238     s.prepend( QString::number( seconds ) ); <span class="comment">//hours or minutes depending on above if block</span>
00239 
00240     <span class="keywordflow">return</span> s;
00241 }
00242 
00243 QString
<a name="l00244"></a><a class="code" href="classMetaBundle.html#MetaBundlee0">00244</a> <a class="code" href="classMetaBundle.html#MetaBundlea19">MetaBundle::prettyBitrate</a>( <span class="keywordtype">int</span> i )
00245 {
00246     <span class="keywordflow">return</span> ( i % 32 == 0 &amp;&amp; i &lt; 257 ) ? <a class="code" href="metabundle_8cpp.html#a0">bitrateStore</a>[ i /32 ] : <a class="code" href="classMetaBundle.html#MetaBundleh0">prettyGeneric</a>( i18n( <span class="stringliteral">"Bitrate"</span>, <span class="stringliteral">"%1 kbps"</span> ), i );
00247 }
00248 
00249 QString
<a name="l00250"></a><a class="code" href="classMetaBundle.html#MetaBundleh0">00250</a> <a class="code" href="classMetaBundle.html#MetaBundleh0">MetaBundle::prettyGeneric</a>( <span class="keyword">const</span> QString &amp;s, <span class="keywordtype">int</span> i ) <span class="comment">//static</span>
00251 {
00252     <span class="comment">//TODO ensure this inlines</span>
00253 
00254     <span class="keywordflow">return</span> ( i &gt; 0 ) ? s.arg( i ) : ( i == <a class="code" href="classMetaBundle.html#MetaBundles0">Undetermined</a> ) ? <span class="stringliteral">"?"</span> : QString::null;
00255 }
<a name="l00256"></a><a class="code" href="classMetaBundle.html#MetaBundlea8">00256</a> <span class="keywordtype">bool</span> <a class="code" href="classMetaBundle.html#MetaBundlea8">MetaBundle::exist</a>()
00257 {
00258         <span class="keywordflow">return</span> <a class="code" href="classMetaBundle.html#MetaBundler11">exists</a>;
00259 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri May 13 16:53:36 2005 for HDASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
