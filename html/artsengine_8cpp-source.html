<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>HDASS: artsengine.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>artsengine.cpp</h1><a href="artsengine_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/***************************************************************************</span>
00002 <span class="comment">                      artsengine.cpp  -  aRts audio interface</span>
00003 <span class="comment">                         -------------------</span>
00004 <span class="comment">begin                : Dec 31 2003</span>
00005 <span class="comment">copyright            : (C) 2003 by Mark Kretschmann</span>
00006 <span class="comment">email                : markey@web.de</span>
00007 <span class="comment">***************************************************************************/</span>
00008 
00009 <span class="comment">/***************************************************************************</span>
00010 <span class="comment"> *                                                                         *</span>
00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
00012 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
00013 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
00014 <span class="comment"> *   (at your option) any later version.                                   *</span>
00015 <span class="comment"> *                                                                         *</span>
00016 <span class="comment"> ***************************************************************************/</span>
00017 
00018 <span class="preprocessor">#include "<a class="code" href="amarokarts_8h.html">amarokarts.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="artsengine_8h.html">artsengine.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="enginebase_8h.html">enginebase.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="engineobserver_8h.html">engineobserver.h</a>"</span>
00022 
00023 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00024 <span class="preprocessor">#include &lt;math.h&gt;</span>            <span class="comment">//setVolume(), timerEvent()</span>
00025 <span class="preprocessor">#include &lt;string&gt;</span>
00026 <span class="preprocessor">#include &lt;vector&gt;</span>
00027 
00028 <span class="preprocessor">#include &lt;qdir.h&gt;</span>
00029 <span class="preprocessor">#include &lt;qdom.h&gt;</span>
00030 <span class="preprocessor">#include &lt;qfile.h&gt;</span>
00031 <span class="preprocessor">#include &lt;qlayout.h&gt;</span>
00032 <span class="preprocessor">#include &lt;qstring.h&gt;</span>
00033 <span class="preprocessor">#include &lt;qtextstream.h&gt;</span>
00034 <span class="preprocessor">#include &lt;qtimer.h&gt;</span>
00035 
00036 <span class="preprocessor">#include &lt;kapplication.h&gt;</span>
00037 <span class="preprocessor">#include &lt;arts/kartswidget.h&gt;</span>
00038 <span class="preprocessor">#include &lt;kconfig.h&gt;</span>
00039 <span class="preprocessor">#include &lt;kdebug.h&gt;</span>
00040 <span class="preprocessor">#include &lt;kfileitem.h&gt;</span>
00041 <span class="preprocessor">#include &lt;kgenericfactory.h&gt;</span>
00042 <span class="preprocessor">#include &lt;klocale.h&gt;</span>
00043 <span class="preprocessor">#include &lt;kmessagebox.h&gt;</span>
00044 <span class="preprocessor">#include &lt;kmimetype.h&gt;</span>
00045 <span class="preprocessor">#include &lt;kstandarddirs.h&gt;</span>
00046 <span class="preprocessor">#include &lt;kurl.h&gt;</span>
00047 
00048 <span class="preprocessor">#include &lt;arts/artsflow.h&gt;</span>
00049 <span class="preprocessor">#include &lt;arts/artsgui.h&gt;</span>
00050 <span class="preprocessor">#include &lt;arts/artskde.h&gt;</span>
00051 <span class="preprocessor">#include &lt;arts/artsmodules.h&gt;</span>
00052 <span class="preprocessor">#include &lt;arts/connect.h&gt;</span>
00053 <span class="preprocessor">#include &lt;arts/dynamicrequest.h&gt;</span>
00054 <span class="preprocessor">#include &lt;arts/flowsystem.h&gt;</span>
00055 <span class="preprocessor">#include &lt;arts/kartsdispatcher.h&gt;</span>
00056 <span class="preprocessor">#include &lt;arts/kmedia2.h&gt;</span>
00057 <span class="preprocessor">#include &lt;arts/kplayobjectfactory.h&gt;</span>
00058 <span class="preprocessor">#include &lt;arts/soundserver.h&gt;</span>
00059 
00060 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00061 
00062 
00063 <span class="comment">//AMAROK_EXPORT_PLUGIN( ArtsEngine )</span>
00064 
00065 
<a name="l00066"></a><a class="code" href="classArtsEngine.html#ArtsEnginea0">00066</a> <a class="code" href="classArtsEngine.html#ArtsEnginea0">ArtsEngine::ArtsEngine</a>( )
00067         : <a class="code" href="classEngineBase.html">EngineBase</a>()
00068         , m_pArtsDispatcher( new KArtsDispatcher( this ) )
00069         , m_pPlayObject( 0 )
00070         , m_pPlayObjectXfade( 0 )
00071         , m_scopeId( 0 )
00072         , m_volumeId( 0 )
00073         , m_xfadeFadeout( false )
00074         , m_xfadeValue( 0.0 )
00075         , m_xfadeCurrent( "invalue2" )
00076         , m_pConnectTimer( new QTimer( this ) )
00077 {
00078     kdDebug() &lt;&lt; <span class="stringliteral">"Engine is ready"</span> &lt;&lt; k_funcinfo &lt;&lt; endl;
00079 }
00080 
00081 
<a name="l00082"></a><a class="code" href="classArtsEngine.html#ArtsEnginea1">00082</a> <a class="code" href="classArtsEngine.html#ArtsEnginea1">ArtsEngine::~ ArtsEngine</a>()
00083 {
00084     kdDebug() &lt;&lt; <span class="stringliteral">"BEGIN "</span> &lt;&lt; k_funcinfo &lt;&lt; endl;
00085 
00086     <a class="code" href="classArtsEngine.html#ArtsEnginer18">m_pConnectTimer</a>-&gt;stop();
00087     killTimers();
00088     <span class="keyword">delete</span> <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>;
00089     <span class="keyword">delete</span> <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a>;
00090     <a class="code" href="classArtsEngine.html#ArtsEngined3">saveEffects</a>();
00091 
00092     <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>            = Arts::SoundServerV2::null();
00093     <a class="code" href="classArtsEngine.html#ArtsEnginer8">m_scope</a>             = <a class="code" href="classAmarok_1_1RawScope.html#Amarok_1_1RawScopee0">Amarok::RawScope::null</a>();
00094     <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>             = <a class="code" href="classAmarok_1_1Synth__STEREO__XFADE.html#Amarok_1_1Synth__STEREO__XFADEe0">Amarok::Synth_STEREO_XFADE::null</a>();
00095     <a class="code" href="classArtsEngine.html#ArtsEnginer6">m_volumeControl</a>     = Arts::StereoVolumeControl::null();
00096     <a class="code" href="classArtsEngine.html#ArtsEnginer5">m_effectStack</a>       = Arts::StereoEffectStack::null();
00097     <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a> = Arts::StereoEffectStack::null();
00098     <a class="code" href="classArtsEngine.html#ArtsEnginer7">m_amanPlay</a>          = Arts::Synth_AMAN_PLAY::null();
00099 
00100     kdDebug() &lt;&lt; <span class="stringliteral">"END "</span> &lt;&lt; k_funcinfo &lt;&lt; endl;
00101 }
00102 
00103 
<a name="l00104"></a><a class="code" href="classArtsEngine.html#ArtsEnginea2">00104</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginea2">ArtsEngine::init</a>( <span class="keywordtype">bool</span>&amp; restart, <span class="keywordtype">int</span> scopeSize, <span class="keywordtype">bool</span> restoreEffects )
00105 {
00106     kdDebug() &lt;&lt; <span class="stringliteral">"BEGIN "</span> &lt;&lt; k_funcinfo &lt;&lt; endl;
00107 
00108     <a class="code" href="classArtsEngine.html#ArtsEnginer11">m_scopeSize</a> = 1 &lt;&lt; scopeSize;   
00109     m_restoreEffects = restoreEffects;
00110     m_mixerHW = -1;   <span class="comment">//initialize</span>
00111 
00112     <span class="comment">// We must restart artsd whenever we installed new mcopclasses</span>
00113     <span class="keywordflow">if</span> ( restart )
00114     {
00115         QCString kill_cmdline;
00116         kill_cmdline = <span class="stringliteral">"killall artsd"</span>;
00117 
00118         <span class="keywordtype">int</span> kill_status = ::system( kill_cmdline );
00119         <span class="keywordflow">if</span> ( kill_status != -1 &amp;&amp; WIFEXITED( kill_status ) )
00120         {
00121             kdWarning() &lt;&lt; <span class="stringliteral">"killall artsd succeeded."</span> &lt;&lt; endl;
00122             restart = <span class="keyword">false</span>;
00123         }
00124     }
00125 
00126     KConfig config( <span class="stringliteral">"kcmartsrc"</span> );
00127     config.setGroup( <span class="stringliteral">"Arts"</span> );
00128 
00129     <span class="keywordtype">bool</span> realtime = config.readBoolEntry( <span class="stringliteral">"StartRealtime"</span>, <span class="keyword">true</span> );
00130 
00131     <span class="keywordflow">if</span> ( !realtime )
00132         KMessageBox::information( 0, i18n( <span class="stringliteral">"&lt;p&gt;artsd is not running with &lt;b&gt;realtime priority&lt;/b&gt; which may cause audio playback to \"skip\" and stutter.&lt;p&gt;"</span>
00133                                      <span class="stringliteral">"&lt;p&gt;To use realtime priority, open the KDE Control Center and enable \"Run with highest possible priority\", under &lt;i&gt;Sound System&lt;/i&gt; in the &lt;i&gt;Sound &amp; Multimedia&lt;/i&gt; branch. "</span>
00134                                      <span class="stringliteral">"Some people may also have to check that \"$KDEDIR/bin/artswrapper\" is &lt;b&gt;set suid&lt;/b&gt; (chmod +s).&lt;/p&gt;"</span>
00135                                      <span class="stringliteral">"&lt;p&gt;You may find, however, that playback is fine without increasing the priority of artsd.&lt;/p&gt;"</span> ),
00136                                i18n( <span class="stringliteral">"aRts Problem"</span> ), <span class="stringliteral">"artsRealtimeAdvice"</span> );
00137 
00138     <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a> = Arts::Reference( <span class="stringliteral">"global:Arts_SoundServerV2"</span> );
00139 
00140     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.isNull() || <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.error() )
00141     {
00142         kdWarning() &lt;&lt; <span class="stringliteral">"aRtsd not running.. trying to start"</span> &lt;&lt; endl;
00143         <span class="comment">// aRts seems not to be running, let's try to run it</span>
00144         <span class="comment">// First, let's read the configuration as in kcmarts</span>
00145         QCString cmdline;
00146 
00147         <span class="keywordtype">bool</span> x11Comm = config.readBoolEntry( <span class="stringliteral">"X11GlobalComm"</span>, <span class="keyword">false</span> );
00148 
00149         <span class="comment">// put the value of x11Comm into .mcoprc</span>
00150         {
00151             KConfig X11CommConfig( QDir::homeDirPath() + <span class="stringliteral">"/.mcoprc"</span> );
00152 
00153             <span class="keywordflow">if</span> ( x11Comm )
00154                 X11CommConfig.writeEntry( <span class="stringliteral">"GlobalComm"</span>, <span class="stringliteral">"Arts::X11GlobalComm"</span> );
00155             <span class="keywordflow">else</span>
00156                 X11CommConfig.writeEntry( <span class="stringliteral">"GlobalComm"</span>, <span class="stringliteral">"Arts::TmpGlobalComm"</span> );
00157 
00158             X11CommConfig.sync();
00159         }
00160 
00161         cmdline = QFile::encodeName( KStandardDirs::findExe( QString::fromLatin1( <span class="stringliteral">"kdeinit_wrapper"</span> ) ) );
00162         cmdline += <span class="stringliteral">" "</span>;
00163 
00164         <span class="keywordflow">if</span> ( realtime )
00165             cmdline += QFile::encodeName( KStandardDirs::findExe(
00166                                               QString::fromLatin1( <span class="stringliteral">"artswrapper"</span> ) ) );
00167         <span class="keywordflow">else</span>
00168             cmdline += QFile::encodeName( KStandardDirs::findExe(
00169                                               QString::fromLatin1( <span class="stringliteral">"artsd"</span> ) ) );
00170 
00171         cmdline += <span class="stringliteral">" "</span>;
00172         cmdline += config.readEntry( <span class="stringliteral">"Arguments"</span>, <span class="stringliteral">"-F 10 -S 4096 -s 60 -m artsmessage -l 3 -f -n"</span> ).utf8();
00173 
00174         <span class="keywordtype">int</span> status = ::system( cmdline );
00175 
00176         <span class="keywordflow">if</span> ( status != -1 &amp;&amp; WIFEXITED( status ) )
00177         {
00178             <span class="comment">// We could have a race-condition here.</span>
00179             <span class="comment">// The correct way to do it is to make artsd fork-and-exit</span>
00180             <span class="comment">// after starting to listen to connections (and running artsd</span>
00181             <span class="comment">// directly instead of using kdeinit), but this is better</span>
00182             <span class="comment">// than nothing.</span>
00183             <span class="keywordtype">int</span> time = 0;
00184             <span class="keywordflow">do</span>
00185             {
00186                 <span class="comment">// every time it fails, we should wait a little longer</span>
00187                 <span class="comment">// between tries</span>
00188                 ::sleep( 1 + time / 2 );
00189                 <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a> = Arts::Reference( <span class="stringliteral">"global:Arts_SoundServerV2"</span> );
00190             }
00191             <span class="keywordflow">while</span> ( ++time &lt; 5 &amp;&amp; ( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.isNull() ) );
00192         }
00193     }
00194 
00195     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.isNull() )
00196     {
00197         KMessageBox::error( 0, i18n( <span class="stringliteral">"Cannot start aRts. Exiting."</span> ), i18n( <span class="stringliteral">"Fatal Error"</span> ) );
00198         ::exit( 1 );
00199     }
00200 
00201     { <span class="comment">//amanPlay</span>
00202         <a class="code" href="classArtsEngine.html#ArtsEnginer7">m_amanPlay</a> = Arts::DynamicCast( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.createObject( <span class="stringliteral">"Arts::Synth_AMAN_PLAY"</span> ) );
00203         <a class="code" href="classArtsEngine.html#ArtsEnginer7">m_amanPlay</a>.title( <span class="stringliteral">"amarok"</span> );
00204         <a class="code" href="classArtsEngine.html#ArtsEnginer7">m_amanPlay</a>.autoRestoreID( <span class="stringliteral">"amarok"</span> );
00205         <a class="code" href="classArtsEngine.html#ArtsEnginer7">m_amanPlay</a>.start();
00206     }
00207 
00208     { <span class="comment">//Xfade</span>
00209         <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a> = Arts::DynamicCast( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.createObject( <span class="stringliteral">"Amarok::Synth_STEREO_XFADE"</span> ) );
00210 
00211         <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>.isNull() ) {
00212             KMessageBox::error( 0,
00213                                 i18n( <span class="stringliteral">"&lt;p&gt;There was an error loading libamarokarts. First try:"</span>
00214                                       <span class="stringliteral">"&lt;pre&gt;killall -9 artsd &amp;&amp; amarok&lt;/pre&gt;"</span>
00215                                       <span class="stringliteral">"If that does not work then amaroK was probably installed with the wrong prefix; "</span>
00216                                       <span class="stringliteral">"please re-configure amaroK using:"</span>
00217                                       <span class="stringliteral">"&lt;pre&gt;./configure --prefix=`kde-config --prefix` &amp;&amp; su -c \"make install\"&lt;/pre&gt;"</span> ),
00218                                 i18n( <span class="stringliteral">"Fatal Error"</span> ) );
00219             ::exit( 1 );
00220         }
00221 
00222         <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>.<a class="code" href="classAmarok_1_1Synth__STEREO__XFADE.html#Amarok_1_1Synth__STEREO__XFADEa15">percentage</a>( <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> );
00223         <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>.<a class="code" href="classAmarok_1_1Synth__STEREO__XFADE.html#Amarok_1_1Synth__STEREO__XFADEa10">start</a>();
00224     }
00225 
00226     { <span class="comment">//globalEffectStack</span>
00227         <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a> = Arts::DynamicCast( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.createObject( <span class="stringliteral">"Arts::StereoEffectStack"</span> ) );
00228         <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>.start();
00229     }
00230 
00231     { <span class="comment">//effectStack</span>
00232         <a class="code" href="classArtsEngine.html#ArtsEnginer5">m_effectStack</a> = Arts::DynamicCast( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.createObject( <span class="stringliteral">"Arts::StereoEffectStack"</span> ) );
00233         <a class="code" href="classArtsEngine.html#ArtsEnginer5">m_effectStack</a>.start();
00234         <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>.insertBottom( <a class="code" href="classArtsEngine.html#ArtsEnginer5">m_effectStack</a>, <span class="stringliteral">"Effect Stack"</span> );
00235     }
00236 
00237     { <span class="comment">//scope</span>
00238         <a class="code" href="classArtsEngine.html#ArtsEnginer8">m_scope</a> = Arts::DynamicCast( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.createObject( <span class="stringliteral">"Amarok::RawScope"</span> ) );
00239         <a class="code" href="classArtsEngine.html#ArtsEnginer8">m_scope</a>.<a class="code" href="classAmarok_1_1RawScope.html#Amarok_1_1RawScopea11">start</a>();
00240         <a class="code" href="classArtsEngine.html#ArtsEnginer8">m_scope</a>.<a class="code" href="classAmarok_1_1RawScope.html#Amarok_1_1RawScopea16">buffer</a>( <a class="code" href="classArtsEngine.html#ArtsEnginer11">m_scopeSize</a> );
00241         <a class="code" href="classArtsEngine.html#ArtsEnginer10">m_scopeId</a> = <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>.insertTop( <a class="code" href="classArtsEngine.html#ArtsEnginer8">m_scope</a>, <span class="stringliteral">"Analyzer"</span> );
00242     }
00243 
00244     Arts::connect( <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>  , <a class="code" href="classArtsEngine.html#ArtsEnginer7">m_amanPlay</a> );
00245     Arts::connect( <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>, <span class="stringliteral">"outvalue_l"</span>, <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>, <span class="stringliteral">"inleft"</span> );
00246     Arts::connect( <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>, <span class="stringliteral">"outvalue_r"</span>, <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>, <span class="stringliteral">"inright"</span> );
00247 
00248     <span class="keywordflow">if</span> ( m_restoreEffects ) <a class="code" href="classArtsEngine.html#ArtsEngined2">loadEffects</a>();
00249     startTimer( <a class="code" href="classArtsEngine.html#ArtsEnginev0">ARTS_TIMER</a> );
00250     connect( <a class="code" href="classArtsEngine.html#ArtsEnginer18">m_pConnectTimer</a>, SIGNAL( timeout() ), <span class="keyword">this</span>, SLOT( <a class="code" href="classArtsEngine.html#ArtsEnginek1">connectTimeout</a>() ) );
00251 
00252     kdDebug() &lt;&lt; <span class="stringliteral">"END "</span> &lt;&lt; k_funcinfo &lt;&lt; endl;
00253     
00254 }
00255 
00256 
<a name="l00257"></a><a class="code" href="classArtsEngine.html#ArtsEnginea3">00257</a> <span class="keywordtype">bool</span> <a class="code" href="classArtsEngine.html#ArtsEnginea3">ArtsEngine::initMixer</a>( <span class="keywordtype">bool</span> hardware )
00258 {
00259     { <span class="comment">//make sure any previously started volume control gets killed</span>
00260         <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer12">m_volumeId</a> )
00261         {
00262             <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>.remove( <a class="code" href="classArtsEngine.html#ArtsEnginer12">m_volumeId</a> );
00263             <a class="code" href="classArtsEngine.html#ArtsEnginer12">m_volumeId</a> = 0;
00264             <a class="code" href="classArtsEngine.html#ArtsEnginer6">m_volumeControl</a> = Arts::StereoVolumeControl::null();
00265         }
00266         <a class="code" href="classEngineBase.html#EngineBaseb0">closeMixerHW</a>();
00267     }
00268 
00269     <span class="keywordflow">if</span> ( hardware )
00270         hardware = <a class="code" href="classEngineBase.html#EngineBaseb1">initMixerHW</a>();
00271     <span class="keywordflow">else</span>
00272     {
00273         <a class="code" href="classArtsEngine.html#ArtsEnginer6">m_volumeControl</a> = Arts::DynamicCast( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.createObject( <span class="stringliteral">"Arts::StereoVolumeControl"</span> ) );
00274         <a class="code" href="classArtsEngine.html#ArtsEnginer6">m_volumeControl</a>.start();
00275         <a class="code" href="classArtsEngine.html#ArtsEnginer12">m_volumeId</a> = <a class="code" href="classArtsEngine.html#ArtsEnginer4">m_globalEffectStack</a>.insertBottom( <a class="code" href="classArtsEngine.html#ArtsEnginer6">m_volumeControl</a>, <span class="stringliteral">"Volume Control"</span> );
00276     }
00277     <span class="keywordflow">return</span> hardware;
00278 }
00279 
00281 <span class="comment">// PUBLIC METHODS</span>
00283 <span class="comment"></span>
<a name="l00284"></a><a class="code" href="classArtsEngine.html#ArtsEnginea4">00284</a> <span class="keywordtype">bool</span> <a class="code" href="classArtsEngine.html#ArtsEnginea4">ArtsEngine::canDecode</a>( <span class="keyword">const</span> KURL &amp;url, mode_t mode, mode_t permissions )
00285 {
00286     KFileItem fileItem( mode, permissions, url, <span class="keyword">false</span> ); <span class="comment">//false = determineMimeType straight away</span>
00287     KMimeType::Ptr mimetype = fileItem.determineMimeType();
00288 
00289     Arts::TraderQuery query;
00290     query.supports( <span class="stringliteral">"Interface"</span>, <span class="stringliteral">"Arts::PlayObject"</span> );
00291     query.supports( <span class="stringliteral">"MimeType"</span>, mimetype-&gt;name().latin1() );
00292     std::vector&lt;Arts::TraderOffer&gt; *offers = query.query();
00293 
00294     <span class="keywordtype">bool</span> result = !offers-&gt;empty();
00295     <span class="keyword">delete</span> offers;
00296 
00297     <span class="keywordflow">return</span> result;
00298 }
00299 
00300 
<a name="l00301"></a><a class="code" href="classArtsEngine.html#ArtsEnginea6">00301</a> <span class="keywordtype">long</span> <a class="code" href="classArtsEngine.html#ArtsEnginea6">ArtsEngine::position</a>()<span class="keyword"> const</span>
00302 <span class="keyword"></span>{
00303     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> )
00304         <span class="keywordflow">return</span> <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;currentTime().seconds * 1000 +
00305                <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;currentTime().ms;
00306     <span class="keywordflow">else</span>
00307         <span class="keywordflow">return</span> 0;
00308 }
00309 
00310 
<a name="l00311"></a><a class="code" href="classArtsEngine.html#ArtsEnginea7">00311</a> EngineBase::EngineState <a class="code" href="classArtsEngine.html#ArtsEnginea7">ArtsEngine::state</a>()<span class="keyword"> const</span>
00312 <span class="keyword"></span>{
00313     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> &amp;&amp; !<a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;isNull() )
00314     {
00315         <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object().isNull() )
00316             <span class="keywordflow">return</span> Playing;
00317 
00318         <span class="keywordflow">switch</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;state() )
00319         {
00320             <span class="keywordflow">case</span> Arts::posPaused:
00321                 <span class="keywordflow">return</span> Paused;
00322             <span class="keywordflow">case</span> Arts::posPlaying:
00323                 <span class="keywordflow">return</span> Playing;
00324             <span class="keywordflow">case</span> Arts::posIdle:
00325                 <span class="keywordflow">return</span> Idle;
00326         }
00327     }
00328 
00329     <span class="keywordflow">return</span> EngineBase::Empty;
00330 }
00331 
00332 
<a name="l00333"></a><a class="code" href="classArtsEngine.html#ArtsEnginea8">00333</a> <span class="keywordtype">bool</span> <a class="code" href="classArtsEngine.html#ArtsEnginea8">ArtsEngine::isStream</a>()<span class="keyword"> const</span>
00334 <span class="keyword"></span>{
00335     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> )
00336         <span class="keywordflow">return</span> <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;stream();
00337     <span class="keywordflow">else</span>
00338         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00339 }
00340 
00341 
<a name="l00342"></a><a class="code" href="classArtsEngine.html#ArtsEnginea9">00342</a> std::vector&lt;float&gt;* <a class="code" href="classArtsEngine.html#ArtsEnginea9">ArtsEngine::scope</a>()
00343 {
00344     <span class="keywordflow">return</span> <a class="code" href="classArtsEngine.html#ArtsEnginer8">m_scope</a>.<a class="code" href="classAmarok_1_1RawScope.html#Amarok_1_1RawScopea18">scope</a>();
00345 }
00346 
00348 
<a name="l00349"></a><a class="code" href="classArtsEngine.html#ArtsEnginei0">00349</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginei1">ArtsEngine::play</a>( <span class="keyword">const</span> KURL&amp; url )
00350 {
00351     kdDebug() &lt;&lt; k_funcinfo &lt;&lt; endl;
00352     <a class="code" href="classArtsEngine.html#ArtsEnginer14">m_xfadeFadeout</a> = <span class="keyword">false</span>;
00353     <a class="code" href="classArtsEngine.html#ArtsEngined0">startXfade</a>();
00354     KDE::PlayObjectFactory factory( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a> );
00355     <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> = factory.createPlayObject( url, <span class="keyword">false</span> ); <span class="comment">//second parameter: create BUS(true/false)</span>
00356 
00357     <span class="keywordflow">if</span> ( !<a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> || <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;isNull() ) 
00358     {
00359         qWarning(<span class="stringliteral">"Arts Error 1----------------"</span>);
00360         <a class="code" href="classArtsEngine.html#ArtsEnginek1">connectTimeout</a>();
00361         emit <a class="code" href="classEngineBase.html#EngineBasel1">stopped</a>();
00362     }
00363     <span class="keywordflow">else</span>
00364     {      
00365         connect( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>, SIGNAL( destroyed() ), <span class="keyword">this</span>, SIGNAL( <a class="code" href="classEngineBase.html#EngineBasel1">stopped</a>() ) );
00366 
00367         <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object().isNull() ) 
00368         {
00369             kdDebug() &lt;&lt; k_funcinfo &lt;&lt; <span class="stringliteral">" m_pPlayObject-&gt;object().isNull()"</span> &lt;&lt; endl;
00370             qWarning(<span class="stringliteral">"Arts Error 2----------------"</span>);
00371             connect( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>, SIGNAL( playObjectCreated() ), <span class="keyword">this</span>, SLOT( <a class="code" href="classArtsEngine.html#ArtsEnginek0">connectPlayObject</a>() ) );
00372             <a class="code" href="classArtsEngine.html#ArtsEnginer18">m_pConnectTimer</a>-&gt;start( <a class="code" href="classArtsEngine.html#ArtsEnginev1">TIMEOUT</a>, <span class="keyword">true</span> );
00373         }
00374         <span class="keywordflow">else</span> 
00375         {
00376             <a class="code" href="classArtsEngine.html#ArtsEnginek0">connectPlayObject</a>();
00377              qWarning(<span class="stringliteral">"Arts Connect"</span>);
00378         }
00379 
00380         <a class="code" href="classArtsEngine.html#ArtsEnginei1">play</a>();
00381     }
00382 }
00383 
00384 
<a name="l00385"></a><a class="code" href="classArtsEngine.html#ArtsEnginek0">00385</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginek0">ArtsEngine::connectPlayObject</a>() <span class="comment">//SLOT</span>
00386 {
00387     <a class="code" href="classArtsEngine.html#ArtsEnginer18">m_pConnectTimer</a>-&gt;stop();
00388 
00389     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> &amp;&amp; !<a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;isNull() &amp;&amp; !<a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object().isNull() )
00390     {
00391         <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object()._node()-&gt;start();
00392 
00393         <span class="comment">//switch xfade channels</span>
00394         <a class="code" href="classArtsEngine.html#ArtsEnginer16">m_xfadeCurrent</a> = ( <a class="code" href="classArtsEngine.html#ArtsEnginer16">m_xfadeCurrent</a> == <span class="stringliteral">"invalue1"</span> ) ? <span class="stringliteral">"invalue2"</span> : <span class="stringliteral">"invalue1"</span>;
00395 
00396         <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> == 0.0 )
00397             <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> = 1.0;
00398 
00399         Arts::connect( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object(), <span class="stringliteral">"left"</span>, <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>, ( m_xfadeCurrent + <span class="stringliteral">"_l"</span> ).latin1() );
00400         Arts::connect( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object(), <span class="stringliteral">"right"</span>, <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>, ( m_xfadeCurrent + <span class="stringliteral">"_r"</span> ).latin1() );
00401     }
00402 }
00403 
00404 <span class="comment">//SLOT</span>
<a name="l00405"></a><a class="code" href="classArtsEngine.html#ArtsEnginek1">00405</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginek1">ArtsEngine::connectTimeout</a>()
00406 {
00407     kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::connectTimeout()] Cannot initialize PlayObject! Skipping this track."</span> &lt;&lt; endl;
00408     <a class="code" href="classArtsEngine.html#ArtsEnginer18">m_pConnectTimer</a>-&gt;stop();
00409 
00410     <span class="keyword">delete</span> <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>;
00411     <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> = NULL;
00412 }
00413 
00414 
<a name="l00415"></a><a class="code" href="classArtsEngine.html#ArtsEnginei1">00415</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginei1">ArtsEngine::play</a>()
00416 {
00417     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> )
00418     {   
00419         qWarning(<span class="stringliteral">"Arts Play files"</span>);  
00420         <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;play();
00421     }
00422 }
00423 
00424 
<a name="l00425"></a><a class="code" href="classArtsEngine.html#ArtsEnginei2">00425</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginei2">ArtsEngine::stop</a>()
00426 {
00427     kdDebug() &lt;&lt; k_funcinfo &lt;&lt; endl;
00428 
00429     <span class="comment">//switch xfade channels</span>
00430     <a class="code" href="classArtsEngine.html#ArtsEnginer16">m_xfadeCurrent</a> = ( <a class="code" href="classArtsEngine.html#ArtsEnginer16">m_xfadeCurrent</a> == <span class="stringliteral">"invalue1"</span> ) ? <span class="stringliteral">"invalue2"</span> : <span class="stringliteral">"invalue1"</span>;
00431 
00432     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> == 0.0 )
00433         <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> = 1.0;
00434 
00435     <a class="code" href="classArtsEngine.html#ArtsEnginer14">m_xfadeFadeout</a> = <span class="keyword">true</span>;
00436     <a class="code" href="classArtsEngine.html#ArtsEngined0">startXfade</a>();
00437 }
00438 
00439 
<a name="l00440"></a><a class="code" href="classArtsEngine.html#ArtsEnginei3">00440</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginei3">ArtsEngine::pause</a>()
00441 {
00442     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> )
00443     {
00444         <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;pause();
00445     }
00446 }
00447 
00448 
<a name="l00449"></a><a class="code" href="classArtsEngine.html#ArtsEnginei4">00449</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginei4">ArtsEngine::seek</a>( <span class="keywordtype">long</span> ms )
00450 {
00451 kdDebug() &lt;&lt; <span class="stringliteral">"seek"</span> &lt;&lt; ms &lt;&lt; endl;
00452     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> )
00453     {
00454     kdDebug() &lt;&lt; <span class="stringliteral">"if ~~~seek"</span> &lt;&lt; ms &lt;&lt; endl;
00455         Arts::poTime time;
00456         time.ms      = ms % 1000;
00457         time.seconds = ( ms - time.ms ) / 1000;
00458         time.custom  = 0.0;
00459         <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;seek( time );
00460     }
00461 }
00462 
00463 
<a name="l00464"></a><a class="code" href="classArtsEngine.html#ArtsEnginei5">00464</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginei5">ArtsEngine::setVolume</a>( <span class="keywordtype">int</span> percent )
00465 {
00466     m_volume = percent;
00467 
00468     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer12">m_volumeId</a> ) {
00469         <span class="comment">//using a logarithmic function to make the volume slider more natural</span>
00470         <a class="code" href="classArtsEngine.html#ArtsEnginer6">m_volumeControl</a>.scaleFactor( 1.0 - log10( ( 100 - percent) * 0.09 + 1.0 ) );
00471     }
00472     <span class="keywordflow">else</span> {
00473         <a class="code" href="classEngineBase.html#EngineBaseb2">EngineBase::setVolumeHW</a>( percent );
00474     }
00475 }
00476 
00477 
<a name="l00478"></a><a class="code" href="classArtsEngine.html#ArtsEnginea10">00478</a> QStringList <a class="code" href="classArtsEngine.html#ArtsEnginea10">ArtsEngine::availableEffects</a>()<span class="keyword"> const</span>
00479 <span class="keyword"></span>{
00480     QStringList val;
00481     Arts::TraderQuery query;
00482     query.supports( <span class="stringliteral">"Interface"</span>, <span class="stringliteral">"Arts::StereoEffect"</span> );
00483     query.supports( <span class="stringliteral">"Interface"</span>, <span class="stringliteral">"Arts::SynthModule"</span> );
00484     std::vector&lt;Arts::TraderOffer&gt; *offers = query.query();
00485 
00486     <span class="keywordflow">for</span> ( std::vector&lt;Arts::TraderOffer&gt;::iterator i = offers-&gt;begin(); i != offers-&gt;end(); i++ )
00487     {
00488         Arts::TraderOffer &amp;offer = *i;
00489         QCString name = offer.interfaceName().c_str();
00490         val.append( name );
00491     }
00492     <span class="keyword">delete</span> offers;
00493 
00494     <span class="keywordflow">return</span> val;
00495 }
00496 
00497 
<a name="l00498"></a><a class="code" href="classArtsEngine.html#ArtsEnginea11">00498</a> std::vector&lt;long&gt; <a class="code" href="classArtsEngine.html#ArtsEnginea11">ArtsEngine::activeEffects</a>()<span class="keyword"> const</span>
00499 <span class="keyword"></span>{
00500     std::vector&lt;long&gt; vec;
00501     QMap&lt;long, EffectContainer&gt;::ConstIterator it;
00502 
00503     <span class="keywordflow">for</span> ( it = <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.begin(); it != <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.end(); ++it )
00504     {
00505         vec.push_back( it.key() );
00506     }
00507 
00508     <span class="keywordflow">return</span> vec;
00509 }
00510 
00511 
<a name="l00512"></a><a class="code" href="classArtsEngine.html#ArtsEnginea12">00512</a> QString <a class="code" href="classArtsEngine.html#ArtsEnginea12">ArtsEngine::effectNameForId</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )<span class="keyword"> const</span>
00513 <span class="keyword"></span>{
00514     <span class="keyword">const</span> std::string str = (*<a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].effect)._interfaceName();
00515     QString qstr( str.c_str() );
00516 
00517     <span class="keywordflow">return</span> qstr;
00518 }
00519 
00520 
<a name="l00521"></a><a class="code" href="classArtsEngine.html#ArtsEnginea13">00521</a> <span class="keywordtype">bool</span> <a class="code" href="classArtsEngine.html#ArtsEnginea13">ArtsEngine::effectConfigurable</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )<span class="keyword"> const</span>
00522 <span class="keyword"></span>{
00523     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.find(<span class="keywordtype">id</span>) == <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.end() )
00524         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00525 
00526     Arts::TraderQuery query;
00527     query.supports( <span class="stringliteral">"Interface"</span>, <span class="stringliteral">"Arts::GuiFactory"</span> );
00528     query.supports( <span class="stringliteral">"CanCreate"</span>, (*<a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].effect)._interfaceName() );
00529 
00530     std::vector&lt;Arts::TraderOffer&gt; *queryResults = query.query();
00531     <span class="keywordtype">bool</span> yes = queryResults-&gt;size();
00532     <span class="keyword">delete</span> queryResults;
00533 
00534     <span class="keywordflow">return</span> yes;
00535 }
00536 
00537 
<a name="l00538"></a><a class="code" href="classArtsEngine.html#ArtsEnginea14">00538</a> <span class="keywordtype">long</span> <a class="code" href="classArtsEngine.html#ArtsEnginea14">ArtsEngine::createEffect</a>( <span class="keyword">const</span> QString&amp; name )
00539 {
00540     <span class="keyword">const</span> <span class="keywordtype">long</span> error = 0;
00541 
00542     <span class="keywordflow">if</span> ( name.isEmpty() )
00543         <span class="keywordflow">return</span> error;
00544 
00545     Arts::StereoEffect* pFX = <span class="keyword">new</span> Arts::StereoEffect;
00546     *pFX = Arts::DynamicCast( <a class="code" href="classArtsEngine.html#ArtsEnginer3">m_server</a>.createObject( std::string( name.ascii() ) ) );
00547 
00548     <span class="keywordflow">if</span> ( (*pFX).isNull() ) {
00549         kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::createEffect] error: could not create effect."</span> &lt;&lt; endl;
00550         <span class="keyword">delete</span> pFX;
00551         <span class="keywordflow">return</span> error;
00552     }
00553 
00554     pFX-&gt;start();
00555     <span class="keywordtype">long</span> <span class="keywordtype">id</span> = <a class="code" href="classArtsEngine.html#ArtsEnginer5">m_effectStack</a>.insertBottom( *pFX, std::string( name.ascii() ) );
00556 
00557     <span class="keywordflow">if</span> ( !<span class="keywordtype">id</span> ) {
00558         kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::createEffect] error: insertBottom failed."</span> &lt;&lt; endl;
00559         pFX-&gt;stop();
00560         <span class="keyword">delete</span> pFX;
00561         <span class="keywordflow">return</span> error;
00562     }
00563 
00564     <a class="code" href="structArtsEngine_1_1EffectContainer.html">EffectContainer</a> container;
00565     container.<a class="code" href="structArtsEngine_1_1EffectContainer.html#ArtsEngine_1_1EffectContainero0">effect</a> = pFX;
00566     container.<a class="code" href="structArtsEngine_1_1EffectContainer.html#ArtsEngine_1_1EffectContainero1">widget</a> = 0;
00567 
00568     <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.insert( <span class="keywordtype">id</span>, container );
00569 
00570     <span class="keywordflow">return</span> <span class="keywordtype">id</span>;
00571 }
00572 
00573 
<a name="l00574"></a><a class="code" href="classArtsEngine.html#ArtsEnginea15">00574</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginea15">ArtsEngine::removeEffect</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
00575 {
00576     <a class="code" href="classArtsEngine.html#ArtsEnginer5">m_effectStack</a>.remove( <span class="keywordtype">id</span> );
00577 
00578     <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].effect-&gt;stop();
00579     <span class="keyword">delete</span> <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].widget;
00580     <span class="keyword">delete</span> <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].effect;
00581 
00582     <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.remove( <span class="keywordtype">id</span> );
00583 }
00584 
00585 
<a name="l00586"></a><a class="code" href="classArtsEngine.html#ArtsEnginea16">00586</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginea16">ArtsEngine::configureEffect</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
00587 {
00588     <span class="keywordflow">if</span> ( !<a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].widget )
00589     {
00590         <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].widget = <span class="keyword">new</span> <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html">ArtsConfigWidget</a>( *<a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].effect );
00591         <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].widget-&gt;show();
00592     }
00593 }
00594 
00595 
<a name="l00596"></a><a class="code" href="classArtsEngine.html#ArtsEnginea17">00596</a> <span class="keywordtype">bool</span> <a class="code" href="classArtsEngine.html#ArtsEnginea17">ArtsEngine::decoderConfigurable</a>()
00597 {
00598     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> &amp;&amp; !<a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object().isNull() &amp;&amp; !<a class="code" href="classArtsEngine.html#ArtsEnginer17">m_pDecoderConfigWidget</a> )
00599     {
00600         Arts::TraderQuery query;
00601         query.supports( <span class="stringliteral">"Interface"</span>, <span class="stringliteral">"Arts::GuiFactory"</span> );
00602         query.supports( <span class="stringliteral">"CanCreate"</span>, <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object()._interfaceName() );
00603 
00604         std::vector&lt;Arts::TraderOffer&gt; *queryResults = query.query();
00605         <span class="keywordtype">bool</span> yes = queryResults-&gt;size();
00606         <span class="keyword">delete</span> queryResults;
00607 
00608         <span class="keywordflow">return</span> yes;
00609     }
00610     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00611 }
00612 
00613 
<a name="l00614"></a><a class="code" href="classArtsEngine.html#ArtsEnginei6">00614</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEnginei6">ArtsEngine::configureDecoder</a>() <span class="comment">//slot</span>
00615 {
00616     <span class="comment">//this method shows a GUI for an aRts CODEC. currently only working with markey's modplug_artsplugin</span>
00617 
00618     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a> &amp;&amp; !<a class="code" href="classArtsEngine.html#ArtsEnginer17">m_pDecoderConfigWidget</a> )
00619     {
00620         <a class="code" href="classArtsEngine.html#ArtsEnginer17">m_pDecoderConfigWidget</a> = <span class="keyword">new</span> <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html">ArtsConfigWidget</a>( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>-&gt;object() );
00621         connect( <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>, SIGNAL( destroyed() ), <a class="code" href="classArtsEngine.html#ArtsEnginer17">m_pDecoderConfigWidget</a>, SLOT( deleteLater() ) );
00622 
00623         <a class="code" href="classArtsEngine.html#ArtsEnginer17">m_pDecoderConfigWidget</a>-&gt;show();
00624     }
00625 }
00626 
00627 
00629 <span class="comment">// PRIVATE METHODS</span>
00631 <span class="comment"></span>
<a name="l00632"></a><a class="code" href="classArtsEngine.html#ArtsEngined0">00632</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEngined0">ArtsEngine::startXfade</a>()
00633 {
00634      <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a> )
00635     {
00636         <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a>-&gt;halt();
00637         <span class="keyword">delete</span> <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a>;
00638     }
00639 
00640     <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a> = <a class="code" href="classArtsEngine.html#ArtsEnginer1">m_pPlayObject</a>;
00641     m_pPlayObject = 0;
00642 }
00643 
00644 
<a name="l00645"></a><a class="code" href="classArtsEngine.html#ArtsEngined1">00645</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEngined1">ArtsEngine::timerEvent</a>( QTimerEvent* )
00646 {
00647     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> &gt; 0.0 )
00648     {
00649         <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> -= ( m_xfadeLength ) ?  1.0 / m_xfadeLength * <a class="code" href="classArtsEngine.html#ArtsEnginev0">ARTS_TIMER</a> : 1.0;
00650 
00651         <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> &lt;= 0.0 )
00652         {
00653             <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> = 0.0;
00654             <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a> )
00655             {
00656                 <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a>-&gt;halt();
00657                 <span class="keyword">delete</span> <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a>;
00658                 <a class="code" href="classArtsEngine.html#ArtsEnginer2">m_pPlayObjectXfade</a> = 0;
00659             }
00660         }
00661         <span class="keywordtype">float</span> value;
00662         <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine.html#ArtsEnginer14">m_xfadeFadeout</a> )
00663             value = 1.0 - log10( ( 1.0 - <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> ) * 9.0 + 1.0 );
00664         <span class="keywordflow">else</span>
00665             value = log10( <a class="code" href="classArtsEngine.html#ArtsEnginer15">m_xfadeValue</a> * 9.0 + 1.0 );
00666 
00667         <a class="code" href="classArtsEngine.html#ArtsEnginer9">m_xfade</a>.<a class="code" href="classAmarok_1_1Synth__STEREO__XFADE.html#Amarok_1_1Synth__STEREO__XFADEa15">percentage</a>( ( <a class="code" href="classArtsEngine.html#ArtsEnginer16">m_xfadeCurrent</a> == <span class="stringliteral">"invalue2"</span> ) ? value : 1.0 - value );
00668     }
00669 }
00670 
00671 
<a name="l00672"></a><a class="code" href="classArtsEngine.html#ArtsEngined2">00672</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEngined2">ArtsEngine::loadEffects</a>()
00673 {
00674     kdDebug() &lt;&lt; k_funcinfo &lt;&lt; endl;
00675 
00676     QDomDocument doc;
00677     assert( kapp );
00678     QFile file( kapp-&gt;dirs()-&gt;saveLocation( <span class="stringliteral">"data"</span>, kapp-&gt;instanceName() + <span class="stringliteral">"/"</span> ) + <span class="stringliteral">"arts-effects.xml"</span> );
00679 
00680     <span class="keywordflow">if</span> ( !file.open( IO_ReadOnly ) )
00681     {
00682         kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::loadEffects()] error: !file.open()"</span> &lt;&lt; endl;
00683         <span class="keywordflow">return</span>;
00684     }
00685 
00686     QString errorMsg;
00687     <span class="keywordtype">int</span>     errorLine;
00688     <span class="keywordtype">int</span>     errorColumn;
00689     <span class="keywordflow">if</span> ( !doc.setContent( &amp;file, &amp;errorMsg, &amp;errorLine, &amp;errorColumn ) )
00690     {
00691         kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::loadEffects()] error: !doc.setContent()"</span> &lt;&lt; endl;
00692         kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::loadEffects()] errorMsg   : "</span> &lt;&lt; errorMsg    &lt;&lt; endl;
00693         kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::loadEffects()] errorLine  : "</span> &lt;&lt; errorLine   &lt;&lt; endl;
00694         kdWarning() &lt;&lt; <span class="stringliteral">"[ArtsEngine::loadEffects()] errorColumn: "</span> &lt;&lt; errorColumn &lt;&lt; endl;
00695         file.close();
00696         <span class="keywordflow">return</span>;
00697     }
00698 
00699     QDomElement docElem = doc.documentElement();
00700 
00701     <span class="keywordflow">for</span> ( QDomNode n = docElem.firstChild(); !n.isNull(); n = n.nextSibling() )
00702     {
00703         QString effect = n.namedItem( <span class="stringliteral">"effectname"</span> ).firstChild().toText().nodeValue();
00704         kdDebug() &lt;&lt; <span class="stringliteral">"effectname: "</span> &lt;&lt; effect &lt;&lt; endl;
00705 
00706         <span class="keywordtype">long</span> <span class="keywordtype">id</span> = <a class="code" href="classArtsEngine.html#ArtsEnginea14">createEffect</a>( effect );
00707         <span class="keywordflow">for</span> ( QDomNode nAttr = n.firstChild(); <span class="keywordtype">id</span> &amp;&amp; !nAttr.isNull(); nAttr = nAttr.nextSibling() )
00708         {
00709             <span class="keywordflow">if</span> ( nAttr.nodeName() == <span class="stringliteral">"attribute"</span> )
00710             {
00711                 QString name  = nAttr.namedItem( <span class="stringliteral">"name"</span>  ).firstChild().toText().nodeValue();
00712                 QString type  = nAttr.namedItem( <span class="stringliteral">"type"</span>  ).firstChild().toText().nodeValue();
00713                 QString value = nAttr.namedItem( <span class="stringliteral">"value"</span> ).firstChild().toText().nodeValue();
00714 
00715                 kdDebug() &lt;&lt; <span class="stringliteral">"name : "</span> &lt;&lt; name  &lt;&lt; endl;
00716                 kdDebug() &lt;&lt; <span class="stringliteral">"type : "</span> &lt;&lt; type  &lt;&lt; endl;
00717                 kdDebug() &lt;&lt; <span class="stringliteral">"value: "</span> &lt;&lt; value &lt;&lt; endl;
00718 
00719                 Arts::DynamicRequest req( *<a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>[<span class="keywordtype">id</span>].effect );
00720                 std::string set( <span class="stringliteral">"_set_"</span> );
00721                 set.append( std::string( name.latin1() ) );
00722                 req.method( set );
00723 
00724                 Arts::Buffer buf;
00725                 buf.fromString( std::string( value.latin1() ), <span class="stringliteral">""</span> );
00726 
00727                 Arts::Any param;
00728                 param.type = std::string( type.latin1() );
00729                 param.readType( buf );
00730                 req.param( param );
00731 
00732                 <span class="keywordflow">if</span> ( !req.invoke() )
00733                     kdWarning() &lt;&lt; <span class="stringliteral">"DynamicRequest failed."</span> &lt;&lt; endl;
00734             }
00735         }
00736     }
00737 }
00738 
00739 
<a name="l00740"></a><a class="code" href="classArtsEngine.html#ArtsEngined3">00740</a> <span class="keywordtype">void</span> <a class="code" href="classArtsEngine.html#ArtsEngined3">ArtsEngine::saveEffects</a>()
00741 {
00742     QDomDocument doc;
00743     QDomElement root = doc.createElement( <span class="stringliteral">"aRts-Effects"</span> );
00744     doc.appendChild( root );
00745 
00746     <span class="keywordflow">for</span> ( QMap&lt;long, EffectContainer&gt;::Iterator it = <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.begin(); it != <a class="code" href="classArtsEngine.html#ArtsEnginer13">m_effectMap</a>.end(); ++it )
00747     {
00748         QDomElement tagEffect = doc.createElement( <span class="stringliteral">"effect"</span> );
00749         root.appendChild( tagEffect );
00750 
00751             { <span class="comment">//effectname</span>
00752                 QDomElement tag = doc.createElement( <span class="stringliteral">"effectname"</span> );
00753                 tagEffect.appendChild( tag );
00754                 QDomText txt = doc.createTextNode( (*it.data().effect)._interfaceName().c_str() );
00755                 tag.appendChild( txt );
00756             }
00757 
00758         Arts::InterfaceDef def = (*it.data().effect)._queryInterface( (*it.data().effect)._interfaceName() );
00759 
00760         <span class="keywordflow">for</span> ( uint i = 0; i &lt; def.attributes.size(); i++ )
00761         {
00762             QDomElement tagAttribute = doc.createElement( <span class="stringliteral">"attribute"</span> );
00763             tagEffect.appendChild( tagAttribute );
00764 
00765             { <span class="comment">//name</span>
00766                 QDomElement tag = doc.createElement( <span class="stringliteral">"name"</span> );
00767                 tagAttribute.appendChild( tag );
00768                 QDomText txt = doc.createTextNode( def.attributes[i].name.c_str() );
00769                 tag.appendChild( txt );
00770             }
00771 
00772             Arts::DynamicRequest req( *it.data().effect );
00773             req.method( <span class="stringliteral">"_get_"</span> + def.attributes[i].name );
00774             Arts::Any result;
00775             result.type = def.attributes[i].type;
00776 
00777             { <span class="comment">//type</span>
00778                 QDomElement tag = doc.createElement( <span class="stringliteral">"type"</span> );
00779                 tagAttribute.appendChild( tag );
00780                 QDomText txt = doc.createTextNode( def.attributes[i].type.c_str() );
00781                 tag.appendChild( txt );
00782             }
00783 
00784             <span class="keywordflow">if</span> ( !req.invoke( result ) )
00785                 kdWarning() &lt;&lt; <span class="stringliteral">"request failed."</span> &lt;&lt; endl;
00786 
00787             Arts::Buffer buf;
00788             result.writeType( buf );
00789 
00790             { <span class="comment">//value</span>
00791                 QDomElement tag = doc.createElement( <span class="stringliteral">"value"</span> );
00792                 tagAttribute.appendChild( tag );
00793                 QDomText txt = doc.createTextNode( buf.toString( <span class="stringliteral">""</span> ).c_str() );
00794                 tag.appendChild( txt );
00795             }
00796         }
00797         <a class="code" href="classArtsEngine.html#ArtsEnginea15">removeEffect</a>( it.key() );
00798     }
00799 
00800     assert( kapp );
00801     QString path = kapp-&gt;dirs()-&gt;saveLocation( <span class="stringliteral">"data"</span>, kapp-&gt;instanceName() + <span class="stringliteral">"/"</span> ) + <span class="stringliteral">"arts-effects.xml"</span>;
00802     QFile::remove( path );
00803     QFile file( path );
00804     file.open( IO_ReadWrite );
00805     QTextStream stream( &amp;file );
00806     stream &lt;&lt; doc;
00807 }
00808 
00809 
00810 <span class="comment">// CLASS EffectConfigWidget --------------------------------------------------------</span>
00811 
<a name="l00812"></a><a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgeta0">00812</a> <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgeta0">ArtsEngine::ArtsConfigWidget::ArtsConfigWidget</a>( Arts::Object object )
00813         : <a class="code" href="classQWidget.html">QWidget</a>( 0, 0, Qt::WType_TopLevel | Qt::WDestructiveClose )
00814 {
00815     assert( kapp );
00816     setCaption( kapp-&gt;makeStdCaption( QString( object._interfaceName().c_str() ) ) );
00817 
00818     Arts::GenericGuiFactory factory;
00819     <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgetr0">m_gui</a> = factory.createGui( object );
00820 
00821     <span class="keywordflow">if</span> ( <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgetr0">m_gui</a>.isNull() )
00822     {
00823         kdWarning() &lt;&lt; <span class="stringliteral">"Arts::Widget gui == NULL! Returning.."</span> &lt;&lt; endl;
00824         <span class="keywordflow">return</span>;
00825     }
00826 
00827     <span class="keywordflow">else</span>
00828     {
00829         <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgetr1">m_pArtsWidget</a> = <span class="keyword">new</span> KArtsWidget( <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgetr0">m_gui</a>, <span class="keyword">this</span> );
00830 
00831         QBoxLayout *lay = <span class="keyword">new</span> QHBoxLayout( <span class="keyword">this</span> );
00832         lay-&gt;add( <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgetr1">m_pArtsWidget</a> );
00833     }
00834 }
00835 
00836 
<a name="l00837"></a><a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgeta1">00837</a> <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgeta1">ArtsEngine::ArtsConfigWidget::~ArtsConfigWidget</a>()
00838 {
00839     <span class="keyword">delete</span> <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgetr1">m_pArtsWidget</a>;
00840     <a class="code" href="classArtsEngine_1_1ArtsConfigWidget.html#ArtsEngine_1_1ArtsConfigWidgetr0">m_gui</a> = Arts::Widget::null();
00841 }
00842 
00843 
00844 <span class="preprocessor">#include "<a class="code" href="artsengine_8moc.html">artsengine.moc</a>"</span>
00845 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri May 13 16:53:34 2005 for HDASS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
